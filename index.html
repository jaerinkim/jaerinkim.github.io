<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏÉÅÍ∂å.shop - AI Í∏∞Î∞ò ÏÜåÏÉÅÍ≥µÏù∏ Ï†ÑÎûµ Î∂ÑÏÑù ÌîåÎû´Ìèº</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #667eea; --secondary: #764ba2; --bg: #f5f7fa; --text: #333;
            --gray: #e0e0e0; --white: #ffffff; --danger: #e74c3c; --success: #2ecc71; --info: #3498db;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', 'ÎßëÏùÄ Í≥†Îîï', system-ui, sans-serif; background: var(--bg); color: var(--text); overflow: hidden; font-weight: 700; }
        .main-container { display: flex; height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 300px; background: var(--white); box-shadow: 2px 0 8px rgba(0,0,0,0.1); z-index: 1000; display: flex; flex-direction: column; }
        .sidebar-header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: var(--white); padding: 1.5rem; text-align: center; }
        .sidebar-header h1 { font-size: 2rem; margin-bottom: 0.5rem; font-weight: 900; }
        .sidebar-header p { font-size: 1rem; opacity: 0.9; font-weight: 800; }
        .sidebar-nav { flex: 1; overflow-y: auto; padding: 1rem 0; }
        .nav-item { padding: 1rem 1.5rem; cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent; display: flex; align-items: center; gap: 1rem; font-weight: 800; color: #555; font-size: 1rem; }
        .nav-item:hover { background: var(--bg); border-left-color: var(--primary); }
        .nav-item.active { background: #f0f4ff; border-left-color: var(--primary); color: var(--primary); font-weight: 900; }
        .nav-icon { width: 24px; height: 24px; opacity: 0.7; }
        .nav-item.active .nav-icon { opacity: 1; }

        /* Content Area */
        .content-area { flex: 1; position: relative; overflow: hidden; }
        .page { display: none; width: 100%; height: 100%; }
        .page.active { display: block; }
        #map { width: 100%; height: 100%; }

        /* Controls */
        .control-panel { position: absolute; top: 20px; right: 20px; background: var(--white); padding: 2rem; border-radius: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.2); min-width: 400px; max-width: 450px; z-index: 999; }
        .control-panel h3 { color: var(--primary); margin-bottom: 1.5rem; font-size: 1.5rem; font-weight: 900; }
        .control-group { margin-bottom: 1.5rem; }
        .control-group label { display: block; font-weight: 800; margin-bottom: 0.8rem; color: #333; font-size: 1.1rem; }
        .control-group select, .control-group input[type="range"] { width: 100%; padding: 1rem; border: 2px solid var(--gray); border-radius: 12px; font-size: 1.1rem; background: var(--white); transition: all 0.3s; font-weight: 700; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .control-group select:focus, .control-group input:focus { outline: none; border-color: var(--primary); box-shadow: 0 4px 12px rgba(102,126,234,0.3); transform: translateY(-2px); }
        
        /* Toggle Switch */
        .toggle-switch { display: flex; align-items: center; gap: 1rem; cursor: pointer; user-select: none; padding: 0.8rem; border-radius: 12px; background: #f8f9fa; transition: all 0.3s; }
        .toggle-switch input[type="checkbox"] { display: none; }
        .toggle-switch:hover { background: #e9ecef; transform: translateY(-1px); }
        .toggle-slider { width: 60px; height: 32px; background: #ddd; border-radius: 32px; position: relative; transition: all 0.3s; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        .toggle-slider::after { content: ''; position: absolute; width: 28px; height: 28px; background: var(--white); border-radius: 50%; top: 2px; left: 2px; transition: all 0.3s; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
        .toggle-switch input:checked + .toggle-slider { background: linear-gradient(135deg, var(--primary), var(--secondary)); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
        .toggle-switch input:checked + .toggle-slider::after { transform: translateX(28px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        
        /* Map Elements */
        .shop-marker { background: var(--white); border: 3px solid var(--primary); border-radius: 50%; width: 16px; height: 16px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
        .shop-marker:hover { transform: scale(1.5); border-color: var(--secondary); z-index: 1000 !important; }
        .shop-marker.deviation { border-color: var(--danger); background: #ffebee; }
        .shop-tooltip { background: rgba(255,255,255,0.98); padding: 1.2rem; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.2); max-width: 350px; font-size: 0.9rem; border: 2px solid var(--primary); }
        .shop-tooltip h4 { color: var(--primary); margin-bottom: 0.8rem; font-weight: 800; font-size: 1.1rem; }
        .shop-tooltip p { color: #666; line-height: 1.5; margin-bottom: 0.5rem; }
        .shop-tooltip .variable-score { color: var(--primary); font-weight: 800; font-size: 1rem; }
        .shop-tooltip .components { background: #f8f9fa; padding: 0.8rem; border-radius: 8px; margin: 0.5rem 0; }
        .shop-tooltip .component-item { font-size: 0.8rem; color: #555; margin: 0.3rem 0; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: var(--white); padding: 2.5rem; border-radius: 16px; width: 95%; max-width: 1600px; height: 95vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--gray); }
        .modal-title { font-size: 2rem; color: var(--text); font-weight: 900; }
        .modal-close { background: none; border: none; font-size: 2.5rem; cursor: pointer; color: #999; padding: 0.5rem; line-height: 1; }
        .modal-close:hover { color: #666; }
        .modal-body { flex: 1; overflow-y: auto; }

        /* Comparison Layout */
        .comparison-layout { display: flex; gap: 2rem; flex: 1; }
        .comparison-panel { flex: 1; overflow-y: auto; padding-right: 1rem; }
        .stat-bar { margin-bottom: 1.5rem; }
        .stat-label { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: background 0.2s; }
        .stat-label:hover { background: #f8f9fa; }
        .stat-bar-container { height: 12px; background: #f0f0f0; border-radius: 6px; position: relative; overflow: hidden; }
        .stat-bar-fill { height: 100%; position: absolute; top: 0; left: 0; transition: width 0.4s ease; }
        .stat-bar-shop { background: var(--info); z-index: 3; }
        .stat-bar-city { background: #333; z-index: 2; opacity: 0.7; }
        .stat-bar-local { background: var(--danger); z-index: 1; opacity: 0.7; }

        .component-detail { background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-top: 0.8rem; font-size: 0.9rem; border: 1px solid #eee; display: none; }
        .component-item { display: flex; justify-content: space-between; margin-bottom: 0.8rem; padding: 0.5rem; background: var(--white); border-radius: 6px; }
        .kernel-density-chart { margin-top: 1rem; height: 150px; }

        /* Page Styles */
        .page-content { padding: 2.5rem; height: 100%; overflow-y: auto; }
        .page-header { margin-bottom: 2.5rem; }
        .page-header h2 { font-size: 2.5rem; color: var(--text); font-weight: 900; }
        .page-header p { font-size: 1.1rem; color: #666; margin-top: 0.8rem; font-weight: 700; }
        .under-development { display: flex; align-items: center; justify-content: center; height: 100%; font-size: 2.5rem; color: #999; font-weight: 900; }
        
        /* Charts */
        .chart-container { width: 100%; height: 600px; margin: 2rem 0; position: relative; }
        .radar-container { width: 100%; height: 500px; margin: 2rem 0; }
        .dimension-controls { display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .dimension-control { flex: 1; min-width: 200px; }
        .dimension-control label { font-weight: 800; margin-bottom: 0.8rem; color: var(--primary); font-size: 1.1rem; }
        .dimension-control select { padding: 1rem; border: 2px solid var(--gray); border-radius: 12px; font-size: 1rem; background: var(--white); transition: all 0.3s; font-weight: 700; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .dimension-control select:focus { border-color: var(--primary); box-shadow: 0 4px 12px rgba(102,126,234,0.3); transform: translateY(-2px); }
        .chart-container canvas { font-weight: 700 !important; }
        
        /* Point Line Chart for Shop Details */
        .point-line-chart { margin: 1rem 0; position: relative; height: 80px; }
        .point-line { position: relative; height: 8px; background: linear-gradient(90deg, #f0f0f0 0%, #ddd 100%); border-radius: 4px; margin: 1rem 0; }
        .point-marker { position: absolute; width: 16px; height: 16px; border-radius: 50%; top: -4px; cursor: pointer; transition: all 0.2s; z-index: 10; }
        .point-marker.shop { background: var(--info); border: 3px solid var(--white); box-shadow: 0 2px 8px rgba(52, 152, 219, 0.4); }
        .point-marker.city { background: #333; border: 3px solid var(--white); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); }
        .point-marker.local { background: var(--danger); border: 3px solid var(--white); box-shadow: 0 2px 8px rgba(231, 76, 60, 0.4); }
        .point-label { position: absolute; font-size: 0.75rem; font-weight: 900; white-space: nowrap; transform: translateX(-50%); padding: 3px 6px; border-radius: 3px; z-index: 20; }
        .point-label.shop { background: var(--info); color: var(--white); top: -40px; }
        .point-label.city { background: #333; color: var(--white); top: -25px; }
        .point-label.local { background: var(--danger); color: var(--white); top: -55px; }

        /* Buttons */
        .btn { padding: 1rem 2rem; border: none; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: 700; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.15); text-transform: none; letter-spacing: 0.5px; margin: 0; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: var(--white); border: 2px solid transparent; }
        .btn-primary:hover { background: linear-gradient(135deg, var(--secondary), var(--primary)); transform: translateY(-3px); box-shadow: 0 8px 20px rgba(102,126,234,0.4); }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #c0392b); color: var(--white); border: 2px solid transparent; }
        .btn-success { background: linear-gradient(135deg, var(--success), #27ae60); color: var(--white); border: 2px solid transparent; }
        .btn-success:hover { background: linear-gradient(135deg, #27ae60, var(--success)); transform: translateY(-3px); box-shadow: 0 8px 20px rgba(46,204,113,0.4); }
        .btn-danger:hover { background: linear-gradient(135deg, #c0392b, var(--danger)); transform: translateY(-3px); box-shadow: 0 8px 20px rgba(231,76,60,0.4); }

        /* Loading & Download */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 1.5rem; font-size: 1.8rem; color: var(--primary); font-weight: 600; }
        .download-btn { position: fixed; bottom: 30px; right: 30px; width: 70px; height: 70px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 50%; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.3s; z-index: 1000; border: none; }
        .download-btn:hover { transform: scale(1.1); }
        .download-btn svg { width: 28px; height: 28px; fill: var(--white); }

        /* Special styles */
        .heatmap-active .leaflet-marker-pane, .heatmap-active .leaflet-shadow-pane { display: none; }
        .legend-gradient { width: 100%; height: 24px; border-radius: 6px; background: linear-gradient(90deg, #0000ff 0%, #00ff00 25%, #ffff00 50%, #ff8800 75%, #ff0000 100%); }
        .legend-labels { display: flex; justify-content: space-between; font-size: 0.8rem; color: #666; margin-top: 0.4rem; }
        
        .franchise-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin: 2rem 0; }
        .franchise-card { background: var(--white); padding: 2rem; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .outlier-item { background: var(--white); padding: 1.5rem; margin-bottom: 1rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s; }
        .outlier-item:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.15); }
        
        .variable-controls { display: flex; flex-wrap: wrap; gap: 0.5rem; margin: 1rem 0; }
        .variable-tag { background: linear-gradient(135deg, var(--gray), #d0d0d0); padding: 0.7rem 1.2rem; border-radius: 25px; font-size: 0.9rem; display: flex; align-items: center; gap: 0.6rem; transition: all 0.3s; box-shadow: 0 2px 6px rgba(0,0,0,0.1); font-weight: 600; }
        .variable-tag.active { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: var(--white); box-shadow: 0 4px 12px rgba(102,126,234,0.3); transform: translateY(-2px); }
        .variable-remove { background: linear-gradient(135deg, var(--danger), #c0392b); color: var(--white); border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .variable-remove:hover { transform: scale(1.1); box-shadow: 0 4px 8px rgba(231,76,60,0.4); }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <svg width="60" height="60" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12,1A11,11,0,1,0,23,12,11,11,0,0,0,12,1Zm0,19a8,8,0,1,1,8-8A8,8,0,0,1,12,20Z" opacity=".25" fill="currentColor"/>
            <path d="M10.72,19.9a8,8,0,0,1-6.5-9.79A7.77,7.77,0,0,1,10.4,4.16a8,8,0,0,1,9.49,6.52A1.54,1.54,0,0,0,21.38,12h.13a1.37,1.37,0,0,0,1.38-1.54,11,11,0,1,0-12.7,12.39A1.54,1.54,0,0,0,12,21.34h0A1.47,1.47,0,0,0,10.72,19.9Z" fill="currentColor">
                <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/>
            </path>
        </svg>
        <p>Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...</p>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>ÏÉÅÍ∂å.shop</h1>
                <p>AI Í∏∞Î∞ò ÏÜåÏÉÅÍ≥µÏù∏ Ï†ÑÎûµ Î∂ÑÏÑù</p>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item active" data-page="map-page">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    <span>ÏßÄÎèÑ Î∂ÑÏÑù</span>
                </div>
                <div class="nav-item" data-page="comparison-page">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 6l-9.5 9.5-5-5L1 18"></path><polyline points="17 6 23 6 23 12"></polyline>
                    </svg>
                    <span>ÏßÄÏó≠ ÌäπÏÑ± ÎπÑÍµê</span>
                </div>
                <div class="nav-item" data-page="franchise-page">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                    </svg>
                    <span>ÏùåÏãùÏ†ê Ïú†Ìòï Î∂ÑÏÑù</span>
                </div>
                <div class="nav-item" data-page="typemap-page">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <span>ÏùåÏãùÏ†ê Ïú†Ìòï ÏßÄÎèÑ</span>
                </div>
                <div class="nav-item" data-page="strategymap-page">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                        <polyline points="2 17 12 22 22 17"></polyline>
                        <polyline points="2 12 12 17 22 12"></polyline>
                    </svg>
                    <span>Í∞ÄÍ≤åÎ≥Ñ Ï†ÑÎûµ ÏßÄÎèÑ</span>
                </div>
                <hr style="margin: 1.5rem; border: none; border-top: 1px solid var(--gray);">
                <div class="nav-item" data-page="opening-page">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v20m-10-10h20"></path>
                    </svg>
                    <span>Í∞úÏóÖ Ï†ÑÎûµ</span>
                </div>
                <div class="nav-item" data-page="change-page">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="1 4 1 10 7 10"></polyline>
                        <polyline points="23 20 23 14 17 14"></polyline>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                    </svg>
                    <span>ÏóÖÏ¢Ö Î≥ÄÍ≤Ω Ï†ÑÎûµ</span>
                </div>
                <div class="nav-item" data-page="closing-page">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    <span>ÌèêÏóÖ Ï†ÑÎûµ</span>
                </div>
            </nav>
        </div>
        
        <div class="content-area">
            <!-- Feature 0 & 1: Combined Map and Heatmap Page -->
            <div id="map-page" class="page active">
                <div id="map"></div>
            </div>
            
            <!-- Feature 2: Area Characteristics Comparison Page -->
            <div id="comparison-page" class="page"></div>
            
            <!-- Feature 5: Franchise Analysis Page -->
            <div id="franchise-page" class="page"></div>
            
            <!-- Feature 7: Restaurant Type Map Page -->
            <div id="typemap-page" class="page"></div>
            
            <!-- Feature 8: Strategy Map Page -->
            <div id="strategymap-page" class="page"></div>
            
            <!-- Features 9-11: Under Development Pages -->
            <div id="opening-page" class="page"><div class="under-development">Í∞úÎ∞ú Ï§ë</div></div>
            <div id="change-page" class="page"><div class="under-development">Í∞úÎ∞ú Ï§ë</div></div>
            <div id="closing-page" class="page"><div class="under-development">Í∞úÎ∞ú Ï§ë</div></div>
        </div>
    </div>
    
    <!-- Feature 3 & 4: Shop Detail Modal -->
    <div class="modal" id="shopModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="shopModalTitle"></h2>
                <button class="modal-close" onclick="closeModal('shopModal')">&times;</button>
            </div>
            <div class="modal-body comparison-layout">
                <div class="comparison-panel" id="shopDetailSection"></div>
                <div class="comparison-panel" id="shopComparisonSection"></div>
            </div>
        </div>
    </div>
    
    <button class="download-btn" onclick="downloadPDF()" title="Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏ PDF Îã§Ïö¥Î°úÎìú">
        <svg viewBox="0 0 24 24">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
    </button>

<script>
// ==================== GLOBAL STATE ====================
let allRestaurants = [];
let filteredRestaurants = [];
let stats = { city: {}, emd: {}, subcategory: {}, franchise: {} };
let map, heatLayer = null, markerLayer = L.layerGroup();
let currentPage = 'map-page', confidenceThreshold = 70;
let charts = {};
let autoCycleInterval = null;
let isAutoCycling = false;
let currentVariableIndex = 0;

const GwangmyeongCenter = [37.4786, 126.8644];
const AreaBounds = {
    north: 37.4786 + 0.15,   // 3x the original range for much larger coverage
    south: 37.4786 - 0.15,
    east: 126.8644 + 0.15,
    west: 126.8644 - 0.15
};
const loadingOverlay = document.getElementById('loadingOverlay');

const variableLabels = {
    'price_level': 'Í∞ÄÍ≤© ÏàòÏ§Ä', 'price_value_for_money': 'Í∞ÄÏÑ±ÎπÑ',
    'atmosphere_energy_level': 'ÌôúÍ∏∞', 'atmosphere_formality': 'Í≤©Ïãù',
    'atmosphere_soundscape_and_music': 'ÏÜåÏùå/ÏùåÏïÖ', 'atmosphere_olfactory_experience': 'Ìñ•Í∏∞ Í≤ΩÌóò',
    'atmosphere_thematic_coherence_and_immersion': 'ÌÖåÎßà Î™∞ÏûÖÎèÑ', 'aesthetics_design_quality': 'ÎîîÏûêÏù∏ ÌíàÏßà',
    'cleanliness_and_hygiene': 'Ï≤≠Í≤∞ÎèÑ', 'comfort_physical': 'Î¨ºÎ¶¨Ï†Å Ìé∏ÏïàÌï®',
    'social_group_size_suitability': 'Í∑∏Î£π Í∑úÎ™® Ï†ÅÌï©ÏÑ±', 'social_occasion_intimacy': 'ÏÇ¨ÍµêÏ†Å ÏπúÎ∞ÄÎèÑ',
    'offering_quality_core': 'ÌïµÏã¨ ÌíàÏßà', 'offering_variety_and_selection': 'Î©îÎâ¥ Îã§ÏñëÏÑ±',
    'offering_uniqueness_and_novelty': 'Î©îÎâ¥ ÎèÖÌäπÏÑ±', 'offering_customizability': 'Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï',
    'offering_portion_or_quantity': 'Ïñë/Ìè¨ÏÖò', 'operational_speed_and_efficiency': 'Ïö¥ÏòÅ Ìö®Ïú®ÏÑ±',
    'service_staff_friendliness': 'ÏßÅÏõê ÏπúÏ†àÎèÑ', 'service_staff_attentiveness': 'ÏßÅÏõê ÏÑ∏Ïã¨Ìï®',
    'service_staff_expertise': 'ÏßÅÏõê Ï†ÑÎ¨∏ÏÑ±', 'access_location_convenience': 'ÏúÑÏπò Ìé∏ÏùòÏÑ±',
    'access_parking_availability': 'Ï£ºÏ∞® Ìé∏ÏùòÏÑ±', 'access_digital_presence_quality': 'ÎîîÏßÄÌÑ∏ Ïù∏ÏßÄÎèÑ',
    'access_physical_accessibility': 'Î¨ºÎ¶¨Ï†Å Ï†ëÍ∑ºÏÑ±', 'reputation_consistency_and_reliability': 'ÌèâÌåê Ïã†Î¢∞ÎèÑ',
    'clientele_family_friendliness': 'Í∞ÄÏ°± ÏπúÌôîÎèÑ',
    'taste_spiciness': 'Îß§Ïö¥Îßõ', 'taste_sweetness': 'Îã®Îßõ', 'taste_saltiness': 'Ïß†Îßõ',
    'taste_sourness': 'Ïã†Îßõ', 'taste_bitterness': 'Ïì¥Îßõ', 'taste_umami': 'Í∞êÏπ†Îßõ',
    'texture_richness_fattiness': 'ÏãùÍ∞ê/Í∏∞Î¶ÑÍ∏∞', 'temperature_serving': 'Ï†úÍ≥µ Ïò®ÎèÑ',
    'concept_healthiness_or_processing_level': 'Í±¥Í∞ïÏÑ±', 'flavor_complexity_and_aromatics': 'ÎßõÏùò Î≥µÏû°ÏÑ±',
    'food_alcohol_pairing_suitability': 'Ï£ºÎ•ò ÌéòÏñ¥ÎßÅ', 'food_carbohydrate_density': 'ÌÉÑÏàòÌôîÎ¨º Î∞ÄÎèÑ',
};

// ==================== DATA LOADING & PARSING ====================
async function loadAllData() {
    loadingOverlay.style.display = 'flex';
    try {
        // Try to load real data first, fallback to mock data
        let jsonlText = '', csvText = '';
        try {
            const jsonlResponse = await fetch('list.jsonl').catch(() => null);
            const csvResponse = await fetch('data.csv').catch(() => null);
            
            if (jsonlResponse && jsonlResponse.ok) {
                jsonlText = await jsonlResponse.text();
            }
            if (csvResponse && csvResponse.ok) {
                csvText = await csvResponse.text();
            }
        } catch (e) {
            console.log('CORS error or files not found, using mock data:', e.message);
        }
        
        if (jsonlText && csvText && jsonlText.trim()) {
            allRestaurants = parseRealData(jsonlText, csvText);
            console.log('Loaded real data:', allRestaurants.length, 'restaurants');
            
            console.log(`‚úÖ Loaded ${allRestaurants.length} restaurants with variable data`);
        } else {
            console.log('Using mock data due to CORS or missing files');
            allRestaurants = generateMockData();
        }
        
        calculateAllStats();
        initApp();
        
    } catch (error) {
        console.error('Error loading data:', error);
        allRestaurants = generateMockData();
        calculateAllStats();
        initApp();
    } finally {
        loadingOverlay.style.display = 'none';
    }
}

function parseRealData(jsonlText, csvText) {
    const supplementaryData = parseCSV(csvText);
    const jsonlLines = jsonlText.trim().split('\n');
    
    return jsonlLines.map(line => {
        try {
            const data = JSON.parse(line);
            const key = data.key;
            let textPart = data.response.candidates[0].content.parts
                .map(p => p.text).join('')
                .replace(/^```json\n/, '').replace(/\n```$/, '');
            
            const parsed = JSON.parse(textPart);
            const extra = supplementaryData[key] || {};
            
            const restaurant = {
                ...parsed,
                key: key,
                name: key.split(' at ')[0],
                address: key.split(' at ')[1],
                lat: parseFloat(extra['ÏúÑÎèÑ'] || extra.lat) || (GwangmyeongCenter[0] + (Math.random() - 0.5) * 0.3),   // Use ÏúÑÎèÑ column
                lng: parseFloat(extra['Í≤ΩÎèÑ'] || extra.lng) || (GwangmyeongCenter[1] + (Math.random() - 0.5) * 0.3),   // Use Í≤ΩÎèÑ column
                subcategory: extra.subcategory || detectSubcategory(parsed),
                emd: extra.emd_name || getRandomEmd(),
                franchise: detectFranchise(key),
            };
            restaurant.avg_confidence = getAverageConfidence(restaurant);
            

            
            return restaurant;
        } catch(e) {
            console.error("Error parsing line:", e);
            return null;
        }
    }).filter(r => r && r.lat && r.lng && r.avg_confidence >= 70);
}

function parseCSV(text) {
    const lines = text.trim().split('\n');
    if (lines.length < 2) return {};
    const header = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
    const dataMap = {};
    
    console.log('CSV Header:', header); // Debug log
    
    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        const entry = {};
        header.forEach((h, j) => {
            entry[h] = values[j] ? values[j].trim().replace(/"/g, '') : '';
        });
        if (entry.key) {
            // Ensure coordinate mapping
            if (entry['ÏúÑÎèÑ']) entry.lat = entry['ÏúÑÎèÑ'];
            if (entry['Í≤ΩÎèÑ']) entry.lng = entry['Í≤ΩÎèÑ'];
            dataMap[entry.key] = entry;
        }
    }
    
    console.log('Sample CSV entry:', Object.values(dataMap)[0]); // Debug log
    return dataMap;
}

function generateMockData() {
    const emds = ['Í¥ëÎ™ÖÎèô', 'Ï≤†ÏÇ∞Îèô', 'ÌïòÏïàÎèô', 'ÏÜåÌïòÎèô', 'ÌïôÏò®Îèô', 'ÏùºÏßÅÎèô', 'ÎÖ∏Ïò®ÏÇ¨Îèô'];
    const subcategories = ['ÌïúÏãù', 'Ï§ëÏãù', 'ÏùºÏãù', 'ÏñëÏãù', 'Ïπ¥Ìéò', 'Í∞ÑÏãù', 'ÏπòÌÇ®', 'ÌîºÏûê', 'Î∂ÑÏãù', 'Ïà†Ïßë'];
    const franchises = ['Ïä§ÌÉÄÎ≤ÖÏä§', 'Îß•ÎèÑÎÇ†Îìú', 'BBQ', 'ÍπÄÎ∞•Ï≤úÍµ≠', 'Ïù¥ÎîîÏïº', 'Î°ØÎç∞Î¶¨ÏïÑ', 'Î≤ÑÍ±∞ÌÇπ', null, null, null];
    const restaurants = [];
    
    emds.forEach(emd => {
        const count = 30 + Math.floor(Math.random() * 70);
        for (let i = 0; i < count; i++) {
            const subcategory = subcategories[Math.floor(Math.random() * subcategories.length)];
            const franchise = franchises[Math.floor(Math.random() * franchises.length)];
            const restaurant = {
                key: `${emd}${i}_restaurant at Í≤ΩÍ∏∞ÎèÑ Í¥ëÎ™ÖÏãú ${emd} ${i+1}`,
                name: `${emd} ${subcategory} ${i + 1}`,
                address: `Í≤ΩÍ∏∞ÎèÑ Í¥ëÎ™ÖÏãú ${emd} ${i+1}Î≤àÏßÄ`,
                lat: GwangmyeongCenter[0] + (Math.random() - 0.5) * 0.3,   // 3x larger area
                lng: GwangmyeongCenter[1] + (Math.random() - 0.5) * 0.3,
                emd: emd,
                subcategory: subcategory,
                franchise: franchise,
                universal_scores: generateMockScores(),
                subspace_scores: generateMockSubspaceScores(),
                latent_summary: generateLatentSummary(subcategory, emd),
                metadata: { data_completeness_report: { confidence_score: 60 + Math.random() * 40 } }
            };
            restaurant.avg_confidence = getAverageConfidence(restaurant);
            restaurants.push(restaurant);
        }
    });
    
    return restaurants.filter(r => r.avg_confidence >= 70);
}

function generateMockScores() {
    const scores = {};
    Object.keys(variableLabels).forEach(key => {
        scores[key] = {
            components: [
                { component_name: "Ï£ºÏöî Íµ¨ÏÑ±ÏöîÏÜå", point_score: 30 + Math.random() * 60, weight: 0.7 },
                { component_name: "Î≥¥Ï°∞ Íµ¨ÏÑ±ÏöîÏÜå", point_score: 20 + Math.random() * 70, weight: 0.3 }
            ],
            confidence_score: 60 + Math.random() * 40
        };
    });
    return scores;
}

function generateMockSubspaceScores() {
    return {
        "Food & Beverage Taste": {
            activation_confidence: 100,
            taste_spiciness: {
                components: [{ component_name: "Îß§Ïö¥Îßõ Í∞ïÎèÑ", point_score: Math.random() * 100, weight: 1.0 }],
                confidence_score: 70 + Math.random() * 30
            }
        }
    };
}

function generateLatentSummary(subcategory, emd) {
    const summaryTemplates = {
        'ÌïúÏãù': [`${emd}Ïóê ÏúÑÏπòÌïú Ï†ÑÌÜµ ÌïúÏãù Ï†ÑÎ¨∏Ï†êÏúºÎ°ú, ÍπÄÏπòÏ∞åÍ∞úÏôÄ Î∂àÍ≥†Í∏∞Í∞Ä Ïú†Î™ÖÌï©ÎãàÎã§. ÌïúÍµ≠Ïùò Ï†ïÌÜµ ÎßõÏùÑ Ï†úÍ≥µÌï©ÎãàÎã§.`,
                `${emd}Ïùò Í∞ÄÏ†ïÏãù ÌïúÏãùÎãπÏúºÎ°ú, ÏßëÎ∞• Í∞ôÏùÄ Îî∞ÎúªÌïú ÌïúÏãù Î©îÎâ¥Î•º ÏÑ†Î≥¥ÏûÖÎãàÎã§.`],
        'Ï§ëÏãù': [`${emd}Ïóê ÏúÑÏπòÌïú Ï§ëÏãù Ï†ÑÎ¨∏Ï†êÏúºÎ°ú, ÏßúÏû•Î©¥Í≥º ÌÉïÏàòÏú°Ïù¥ Ïù∏Í∏∞ Î©îÎâ¥ÏûÖÎãàÎã§. Ï§ëÍµ≠ Ï†ÑÌÜµ ÏöîÎ¶¨Î•º ÎßõÎ≥º Ïàò ÏûàÏäµÎãàÎã§.`,
                `${emd}Ïùò Ï§ëÍµ≠ÏùåÏãùÏ†êÏúºÎ°ú, Ï∞®Ïù¥ÎãàÏ¶à ÏöîÎ¶¨ÏôÄ Îî§ÏÑ¨ÏùÑ Ï†úÍ≥µÌïòÎäî ÎßõÏßëÏûÖÎãàÎã§.`],
        'ÏùºÏãù': [`${emd}Ïóê ÏúÑÏπòÌïú ÏùºÏãù Ï†ÑÎ¨∏Ï†êÏúºÎ°ú, Ïã†ÏÑ†Ìïú Ï¥àÎ∞•Í≥º ÎùºÎ©òÏùÑ Ï†úÍ≥µÌï©ÎãàÎã§. ÏùºÎ≥∏ Ï†ïÌÜµ Ïä§ÏãúÏôÄ ÏÇ¨ÏãúÎØ∏Í∞Ä Ïú†Î™ÖÌï©ÎãàÎã§.`,
                `${emd}Ïùò ÏùºÎ≥∏ÏöîÎ¶¨Ï†êÏúºÎ°ú, ÎèàÏπ¥Ï∏†ÏôÄ Ïö∞ÎèôÏù¥ Ïù∏Í∏∞ Î©îÎâ¥Ïù∏ ÎßõÏßëÏûÖÎãàÎã§.`],
        'ÏñëÏãù': [`${emd}Ïóê ÏúÑÏπòÌïú ÏñëÏãù Î†àÏä§ÌÜ†ÎûëÏúºÎ°ú, ÌååÏä§ÌÉÄÏôÄ Ïä§ÌÖåÏù¥ÌÅ¨Í∞Ä ÎåÄÌëú Î©îÎâ¥ÏûÖÎãàÎã§. ÏÑúÏñë ÏöîÎ¶¨Ïùò Ï†ïÏàòÎ•º Î≥¥Ïó¨Ï§çÎãàÎã§.`,
                `${emd}Ïùò Ïù¥ÌÉàÎ¶¨Ïïà Î†àÏä§ÌÜ†ÎûëÏúºÎ°ú, ÌîºÏûêÏôÄ Î¶¨Ï°∞ÎòêÍ∞Ä Ïú†Î™ÖÌïú ÎßõÏßëÏûÖÎãàÎã§.`],
        'Ïπ¥Ìéò': [`${emd}Ïóê ÏúÑÏπòÌïú ÏïÑÎäëÌïú Ïπ¥ÌéòÎ°ú, Ïã†ÏÑ†Ìïú Ïª§ÌîºÏôÄ ÎîîÏ†ÄÌä∏Î•º Ï†úÍ≥µÌï©ÎãàÎã§.`,
                `${emd}Ïùò Î∂ÑÏúÑÍ∏∞ Ï¢ãÏùÄ Ïπ¥ÌéòÎ°ú, Îã§ÏñëÌïú ÏùåÎ£åÏôÄ Î∏åÎü∞ÏπòÎ•º Ï¶êÍ∏∏ Ïàò ÏûàÏäµÎãàÎã§.`],
        'ÏπòÌÇ®': [`${emd}Ïóê ÏúÑÏπòÌïú ÏπòÌÇ® Ï†ÑÎ¨∏Ï†êÏúºÎ°ú, Î∞îÏÇ≠Ìïú ÌõÑÎùºÏù¥Îìú ÏπòÌÇ®Í≥º ÏñëÎÖêÏπòÌÇ®Ïù¥ Ïú†Î™ÖÌï©ÎãàÎã§.`,
                `${emd}Ïùò ÏπòÌÇ®ÏßëÏúºÎ°ú, Îã≠Í∞ïÏ†ïÍ≥º Í∞ÅÏ¢Ö ÏπòÌÇ® Î©îÎâ¥Î•º Ï†úÍ≥µÌïòÎäî ÎßõÏßëÏûÖÎãàÎã§.`],
        'ÌîºÏûê': [`${emd}Ïóê ÏúÑÏπòÌïú ÌîºÏûê Ï†ÑÎ¨∏Ï†êÏúºÎ°ú, Îã§ÏñëÌïú ÌÜ†ÌïëÏùò ÌîºÏûêÎ•º Ï†úÍ≥µÌï©ÎãàÎã§.`,
                `${emd}Ïùò Ïù¥ÌÉàÎ¶¨Ïïà ÌîºÏûêÏßëÏúºÎ°ú, ÏàòÏ†ú ÎèÑÏö∞ ÌîºÏûêÍ∞Ä Ïù∏Í∏∞Ïù∏ ÎßõÏßëÏûÖÎãàÎã§.`],
        'Î∂ÑÏãù': [`${emd}Ïóê ÏúÑÏπòÌïú Î∂ÑÏãùÏ†êÏúºÎ°ú, Îñ°Î≥∂Ïù¥ÏôÄ ÏàúÎåÄÍ∞Ä ÎåÄÌëú Î©îÎâ¥ÏûÖÎãàÎã§.`,
                `${emd}Ïùò Í∏∏Í±∞Î¶¨ ÏùåÏãùÏ†êÏúºÎ°ú, ÍπÄÎ∞•Í≥º ÎùºÎ©¥ÏùÑ Ìï®Íªò Ï¶êÍ∏∏ Ïàò ÏûàÎäî ÎßõÏßëÏûÖÎãàÎã§.`],
        'Í∞ÑÏãù': [`${emd}Ïóê ÏúÑÏπòÌïú Í∞ÑÏãù Ï†ÑÎ¨∏Ï†êÏúºÎ°ú, Îã§ÏñëÌïú ÎîîÏ†ÄÌä∏ÏôÄ ÏùåÎ£åÎ•º Ï†úÍ≥µÌï©ÎãàÎã§.`,
                `${emd}Ïùò ÎîîÏ†ÄÌä∏ Ïπ¥ÌéòÎ°ú, ÏºÄÏù¥ÌÅ¨ÏôÄ ÏïÑÏù¥Ïä§ÌÅ¨Î¶ºÏù¥ Ïú†Î™ÖÌïú ÎßõÏßëÏûÖÎãàÎã§.`],
        'Ïà†Ïßë': [`${emd}Ïóê ÏúÑÏπòÌïú Ï£ºÏ†êÏúºÎ°ú, Îß•Ï£ºÏôÄ ÏïàÏ£ºÍ∞Ä ÎßõÏûàÎäî Í≥≥ÏûÖÎãàÎã§.`,
                `${emd}Ïùò Ìò∏ÌîÑÏßëÏúºÎ°ú, ÏπòÌÇ®Í≥º Îß•Ï£ºÎ•º Ï¶êÍ∏∏ Ïàò ÏûàÎäî Ïù∏Í∏∞ Ïà†ÏßëÏûÖÎãàÎã§.`]
    };
    
    const templates = summaryTemplates[subcategory] || summaryTemplates['ÌïúÏãù'];
    return templates[Math.floor(Math.random() * templates.length)];
}

function detectSubcategory(data) {
    const summary = data.latent_summary || '';
    if (summary.includes('ÌïúÏãù') || summary.includes('ÍπÄÏπò')) return 'ÌïúÏãù';
    if (summary.includes('Ï§ëÏãù') || summary.includes('Ï§ëÍµ≠') || summary.includes('Ï∞®Ïù¥ÎãàÏ¶à')) return 'Ï§ëÏãù';
    if (summary.includes('ÏùºÏãù') || summary.includes('Ï¥àÎ∞•') || summary.includes('Ïä§Ïãú') || summary.includes('ÎùºÎ©ò')) return 'ÏùºÏãù';
    if (summary.includes('ÏñëÏãù') || summary.includes('ÌååÏä§ÌÉÄ') || summary.includes('Ïä§ÌÖåÏù¥ÌÅ¨')) return 'ÏñëÏãù';
    if (summary.includes('Ïπ¥Ìéò') || summary.includes('Ïª§Ìîº')) return 'Ïπ¥Ìéò';
    if (summary.includes('Í∞ÑÏãù') || summary.includes('ÎîîÏ†ÄÌä∏')) return 'Í∞ÑÏãù';
    if (summary.includes('ÏπòÌÇ®') || summary.includes('Îã≠')) return 'ÏπòÌÇ®';
    if (summary.includes('ÌîºÏûê')) return 'ÌîºÏûê';
    if (summary.includes('Î∂ÑÏãù') || summary.includes('Îñ°Î≥∂Ïù¥')) return 'Î∂ÑÏãù';
    if (summary.includes('Ïà†Ïßë') || summary.includes('Îß•Ï£º')) return 'Ïà†Ïßë';
    return 'ÌïúÏãù';
}

function detectFranchise(key) {
    const franchises = ['Ïä§ÌÉÄÎ≤ÖÏä§', 'Îß•ÎèÑÎÇ†Îìú', 'BBQ', 'ÍπÄÎ∞•Ï≤úÍµ≠', 'Ïù¥ÎîîÏïº', 'Î°ØÎç∞Î¶¨ÏïÑ', 'Î≤ÑÍ±∞ÌÇπ'];
    const name = key.toLowerCase();
    return franchises.find(f => name.includes(f.toLowerCase())) || null;
}

function getRandomEmd() {
    const emds = ['Í¥ëÎ™ÖÎèô', 'Ï≤†ÏÇ∞Îèô', 'ÌïòÏïàÎèô', 'ÏÜåÌïòÎèô', 'ÌïôÏò®Îèô', 'ÏùºÏßÅÎèô', 'ÎÖ∏Ïò®ÏÇ¨Îèô'];
    return emds[Math.floor(Math.random() * emds.length)];
}

// ==================== CORE FUNCTIONS ====================
function getAverageConfidence(restaurant) {
    const scores = restaurant.universal_scores || {};
    const confidences = Object.values(scores).map(s => s.confidence_score || 0).filter(c => c > 0);
    return confidences.length > 0 ? confidences.reduce((a, b) => a + b, 0) / confidences.length : 0;
}

function getScoreValue(restaurant, variable) {
    const universalScore = restaurant.universal_scores && restaurant.universal_scores[variable];
    const subspaceScore = restaurant.subspace_scores && restaurant.subspace_scores['Food & Beverage Taste'] && restaurant.subspace_scores['Food & Beverage Taste'][variable];
    const scoreData = universalScore || subspaceScore;

    if (!scoreData || !scoreData.components || scoreData.components.length === 0) {

        return 0;
    }
    
    const calculatedScore = scoreData.components.reduce((sum, c) => sum + (c.point_score * c.weight), 0);
    

    
    return calculatedScore;
}

function calculateAllStats() {
    const vars = Object.keys(variableLabels);
    
    // City-wide stats
    stats.city = {};
    vars.forEach(v => {
        const values = allRestaurants.map(r => getScoreValue(r, v));
        stats.city[v] = { mean: values.reduce((a,b)=>a+b,0) / values.length };
    });

    // EMD stats
    stats.emd = {};
    const emds = [...new Set(allRestaurants.map(r => r.emd))];
    emds.forEach(emdName => {
        stats.emd[emdName] = {};
        const emdRestaurants = allRestaurants.filter(r => r.emd === emdName);
        vars.forEach(v => {
            const values = emdRestaurants.map(r => getScoreValue(r, v));
            stats.emd[emdName][v] = { mean: values.reduce((a,b)=>a+b,0) / values.length };
        });
    });
    
    // Subcategory stats
    stats.subcategory = {};
    const subcategories = [...new Set(allRestaurants.map(r => r.subcategory))];
    subcategories.forEach(subcat => {
        stats.subcategory[subcat] = {};
        const subcatRestaurants = allRestaurants.filter(r => r.subcategory === subcat);
        vars.forEach(v => {
            const values = subcatRestaurants.map(r => getScoreValue(r, v));
            stats.subcategory[subcat][v] = { mean: values.reduce((a,b)=>a+b,0) / values.length };
        });
    });

    // Franchise stats
    stats.franchise = {};
    const franchises = [...new Set(allRestaurants.map(r => r.franchise).filter(f => f))];
    franchises.forEach(franchise => {
        stats.franchise[franchise] = {};
        const franchiseRestaurants = allRestaurants.filter(r => r.franchise === franchise);
        vars.forEach(v => {
            const values = franchiseRestaurants.map(r => getScoreValue(r, v));
            stats.franchise[franchise][v] = { mean: values.reduce((a,b)=>a+b,0) / values.length };
        });
    });
}

function isDeviation(restaurant) {
    if (!restaurant.emd || !stats.emd[restaurant.emd]) return false;
    const emdAvgs = stats.emd[restaurant.emd];
    let totalDeviation = 0, count = 0;
    for (const variable in emdAvgs) {
        const shopScore = getScoreValue(restaurant, variable);
        const emdScore = emdAvgs[variable].mean;
        if(emdScore > 0) {
             totalDeviation += Math.abs(shopScore - emdScore) / emdScore;
             count++;
        }
    }
    return (count > 0) && (totalDeviation / count > 0.25);
}

// ==================== INITIALIZATION ====================
function initApp() {
    initMap();
    setupEventListeners();
    navigateTo('map-page');
}

function initMap() {
    map = L.map('map', { center: GwangmyeongCenter, zoom: 12, scrollWheelZoom: true }); // Zoomed out to show larger area
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
    }).addTo(map);
    markerLayer.addTo(map);
}

function setupEventListeners() {
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => navigateTo(item.dataset.page));
    });
}

// ==================== PAGE NAVIGATION ====================
function navigateTo(pageId) {
    currentPage = pageId;
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    
    document.querySelectorAll('.nav-item').forEach(n => {
        n.classList.toggle('active', n.dataset.page === pageId);
    });
    
    clearMapVisuals();
    removeExistingControls();

    switch (pageId) {
        case 'map-page': renderMapPage(); break;
        case 'comparison-page': renderComparisonPage(); break;
        case 'franchise-page': renderFranchisePage(); break;
        case 'typemap-page': renderTypeMapPage(); break;
        case 'strategymap-page': renderStrategyMapPage(); break;
    }
}

function removeExistingControls() {
    document.querySelectorAll('.control-panel').forEach(panel => panel.remove());
}

function clearMapVisuals() {
    markerLayer.clearLayers();
    if (heatLayer) {
        map.removeLayer(heatLayer);
        heatLayer = null;
    }
    document.body.classList.remove('heatmap-active');
}

// ==================== FEATURE 0 & 1: COMBINED MAP AND HEATMAP PAGE ====================
function renderMapPage() {
    if (!document.getElementById('map').parentElement.classList.contains('active')) {
        document.getElementById('map-page').appendChild(document.getElementById('map'));
    }
    
    const controlPanel = createControlPanel();
    controlPanel.innerHTML = `
        <h3>üó∫Ô∏è ÏßÄÎèÑ Î∂ÑÏÑù</h3>
        <div class="control-group">
            <label for="heatmapVariable" style="font-weight: 800;">ÌûàÌä∏Îßµ Î≥ÄÏàò</label>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <select id="heatmapVariable" onchange="updateMapVisualization()" style="font-weight: 700; flex: 1;">
                    ${Object.entries(variableLabels).map(([k,v]) => `<option value="${k}">${v}</option>`).join('')}
                </select>
                <button id="autoCycleBtn" onclick="toggleAutoCycle()" class="btn btn-primary" style="padding: 0.8rem; min-width: 100px; font-size: 0.9rem;">
                    ‚ñ∂Ô∏è ÏûêÎèô
                </button>

            </div>
        </div>
        <div class="control-group">
            <label for="mapCategoryFilter" style="font-weight: 800;">ÏóÖÏ¢Ö ÌïÑÌÑ∞</label>
            <select id="mapCategoryFilter" style="font-weight: 700;">
                <option value="all">Ï†ÑÏ≤¥</option>
                ${[...new Set(allRestaurants.map(r => r.subcategory))].sort().map(s => `<option value="${s}">${s}</option>`).join('')}
            </select>
        </div>
        <div class="control-group">
            <button id="nicheModeBtn" onclick="toggleNicheMode()" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1rem;">
                ÌãàÏÉàÏãúÏû•ÏùÑ ÌëúÏãú
            </button>
        </div>
        <div style="margin-top: 1.5rem;">
            <div style="font-weight: 800; margin-bottom: 0.5rem; color: var(--primary);">ÌûàÌä∏Îßµ Î≤îÏúÑ</div>
            <div class="legend-gradient"></div>
            <div class="legend-labels"><span style="font-weight: 700;">ÎÇÆÏùå</span><span style="font-weight: 700;">ÎÜíÏùå</span></div>
        </div>
    `;
    document.getElementById('map-page').appendChild(controlPanel);
    
    setupMapControls();
    // Initialize filteredRestaurants first, then show both markers and heatmap
    setTimeout(() => {
        applyMapFilters();
        // Auto-start cycling by default
        startAutoCycle();
        const btn = document.getElementById('autoCycleBtn');
        btn.innerHTML = '‚è∏Ô∏è ÏùºÏãúÏ†ïÏßÄ';
        btn.style.background = 'linear-gradient(135deg, var(--success), #27ae60)';
        isAutoCycling = true;
    }, 100);
}

function updateMapVisualization() {
    // Show both markers and heatmap simultaneously
    // Update markers first to reflect current variable
    renderMapMarkers();
    updateHeatmap();
    
    // Log current variable for debugging
    const currentVar = document.getElementById('heatmapVariable')?.value;
    console.log(`Map visualization updated for variable: ${currentVar} (${variableLabels[currentVar]})`);
}

function setupMapControls() {
    const categoryFilter = document.getElementById('mapCategoryFilter');
    
    categoryFilter.addEventListener('change', applyMapFilters);
    
    // Set up auto-cycle functionality
    window.toggleAutoCycle = () => {
        const btn = document.getElementById('autoCycleBtn');
        if (isAutoCycling) {
            clearInterval(autoCycleInterval);
            isAutoCycling = false;
            btn.innerHTML = '‚ñ∂Ô∏è ÏûêÎèô';
            btn.style.background = 'linear-gradient(135deg, var(--primary), var(--secondary))';
        } else {
            startAutoCycle();
            isAutoCycling = true;
            btn.innerHTML = '‚è∏Ô∏è ÏùºÏãúÏ†ïÏßÄ';
            btn.style.background = 'linear-gradient(135deg, var(--success), #27ae60)';
        }
    };
    
    // Set up niche mode toggle
    window.toggleNicheMode = () => {
        const btn = document.getElementById('nicheModeBtn');
        const isNicheMode = btn.textContent.includes('ÌãàÏÉàÏãúÏû•ÏùÑ');
        
        if (isNicheMode) {
            btn.innerHTML = 'Î™®Îì† Í∞ÄÍ≤åÎ•º ÌëúÏãú';
            btn.style.background = 'linear-gradient(135deg, var(--danger), #c0392b)';
            filteredRestaurants = allRestaurants.filter(r => {
                const confidencePass = r.avg_confidence >= 70;
                const categoryPass = document.getElementById('mapCategoryFilter').value === 'all' || r.subcategory === document.getElementById('mapCategoryFilter').value;
                return confidencePass && categoryPass && isDeviation(r);
            });
        } else {
            btn.innerHTML = 'ÌãàÏÉàÏãúÏû•ÏùÑ ÌëúÏãú';
            btn.style.background = 'linear-gradient(135deg, var(--primary), var(--secondary))';
            applyMapFilters();
            return;
        }
        
        updateMapVisualization();
    };
}

function startAutoCycle() {
    const variableKeys = Object.keys(variableLabels);
    
    autoCycleInterval = setInterval(() => {
        currentVariableIndex = (currentVariableIndex + 1) % variableKeys.length;
        const newVariable = variableKeys[currentVariableIndex];
        
        console.log(`Auto-cycling to: ${variableLabels[newVariable]}`);
        document.getElementById('heatmapVariable').value = newVariable;
        updateMapVisualization(); // This will update both heatmap and markers
    }, 5000);
}

function applyMapFilters() {
    const categoryFilter = document.getElementById('mapCategoryFilter');
    
    if (!categoryFilter) return;
    
    const selectedCategory = categoryFilter.value;
    
    filteredRestaurants = allRestaurants.filter(r => {
        const confidencePass = r.avg_confidence >= 70; // Fixed at 70
        const categoryPass = selectedCategory === 'all' || r.subcategory === selectedCategory;
        return confidencePass && categoryPass;
    });

    updateMapVisualization();
}

function renderMapMarkers() {
    markerLayer.clearLayers();
    const sampleSize = 200;
    const sampled = filteredRestaurants.length > sampleSize 
        ? [...filteredRestaurants].sort(() => 0.5 - Math.random()).slice(0, sampleSize)
        : filteredRestaurants;

    const currentVariable = document.getElementById('heatmapVariable')?.value || 'price_level';

    sampled.forEach(r => {
        const markerIcon = L.divIcon({
            className: `shop-marker ${isDeviation(r) ? 'deviation' : ''}`,
            iconSize: [16, 16]
        });
        
        // Get variable components for hover display
        const variableScore = getScoreValue(r, currentVariable);
        const variableData = r.universal_scores?.[currentVariable] || r.subspace_scores?.['Food & Beverage Taste']?.[currentVariable];
        const components = variableData?.components || [];
        
        let tooltipContent = `<h4>${r.name}</h4>`;
        tooltipContent += `<p class=\"variable-score\">${variableLabels[currentVariable]}: ${variableScore.toFixed(1)}Ï†ê</p>`;
        
        if (components.length > 0) {
            tooltipContent += `<div class="components">`;
            tooltipContent += `<strong style="color: var(--secondary); font-size: 0.9rem;">üìä Íµ¨ÏÑ±ÏöîÏÜå Î∂ÑÏÑù</strong><br/>`;
            components.forEach(c => {
                const percentage = (c.weight * 100).toFixed(0);
                tooltipContent += `<div class="component-item">‚Ä¢ ${c.component_name}: <span style="color: var(--primary); font-weight: 700;">${c.point_score.toFixed(1)}Ï†ê</span> <span style="color: #888;">(${percentage}%)</span></div>`;
            });
            tooltipContent += `</div>`;
        }
        
        tooltipContent += `<p style="margin-top: 0.8rem; font-size: 0.8rem; color: #666; font-style: italic;">${r.latent_summary || 'ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏóÜÏùå'}</p>`;
        
        const marker = L.marker([r.lat, r.lng], { icon: markerIcon })
            .bindTooltip(tooltipContent, {
                className: 'shop-tooltip',
                offset: [0, -10],
                permanent: false,
                sticky: true,
                maxWidth: 350
            })
            .on('click', () => showShopDetailModal(r));
        markerLayer.addLayer(marker);
    });
}

function updateHeatmap() {
    if (heatLayer) {
        map.removeLayer(heatLayer);
        heatLayer = null;
    }
    
    const variable = document.getElementById('heatmapVariable')?.value || 'price_level';
    const category = document.getElementById('mapCategoryFilter')?.value || 'all';
    
    console.log(`üó∫Ô∏è Updating heatmap: ${variableLabels[variable]} (${category} category)`);
    
    // Create a comprehensive kernel density grid even where no restaurants exist
    const gridData = generateKernelDensityGrid(variable, category);
    
    if (gridData.length > 0) {
        // Calculate actual value distribution for verification
        const values = gridData.map(point => point[2]);
        const minVal = Math.min(...values);
        const maxVal = Math.max(...values);
        const avgVal = values.reduce((a,b) => a+b, 0) / values.length;
        
        // Log brief heatmap statistics
        console.log(`üìä Heatmap: ${variableLabels[variable]} | Range: ${minVal.toFixed(2)}-${maxVal.toFixed(2)} | Points: ${gridData.length}`);
        
        // Use actual data range for proper scaling
        const actualRange = maxVal - minVal;
        const normalizedMax = actualRange > 0.1 ? 1.0 : Math.max(maxVal, 0.6); // Ensure visible range
        
        heatLayer = L.heatLayer(gridData, {
            radius: 30,        // Larger radius for better coverage
            blur: 20,          // More blur to eliminate hard edges
            maxZoom: 17,
            minOpacity: 0.3,
            // Let leaflet auto-detect max for proper scaling
            gradient: {
                0.0: '#0033ff',    // Deep blue for lowest
                0.25: '#00aaff',   // Light blue  
                0.5: '#00ff55',    // Green for medium
                0.75: '#ffff00',   // Yellow 
                0.9: '#ff8800',    // Orange
                1.0: '#ff0000'     // Red for highest
            }
        }).addTo(map);
        

    }
}

function generateKernelDensityGrid(variable, category) {
    const filteredRestaurants = allRestaurants.filter(r => {
        return (r.avg_confidence >= 70) && (category === 'all' || r.subcategory === category);
    });
    
    if (filteredRestaurants.length === 0) {
        console.warn(`‚ö†Ô∏è No restaurants found for ${variableLabels[variable]} with current filters`);
        return [];
    }
    
    // Calculate actual score range for proper color scaling
    const scores = filteredRestaurants.map(r => getScoreValue(r, variable));
    const validScores = scores.filter(s => s > 0);
    const minScore = Math.min(...scores);
    const maxScore = Math.max(...scores);
    const scoreRange = maxScore - minScore;
    
    console.log(`üî¢ Data: ${filteredRestaurants.length} restaurants | Score range: ${minScore.toFixed(1)}-${maxScore.toFixed(1)}`);
    
    if (scoreRange < 5) {
        console.warn(`‚ö†Ô∏è Low variation in ${variableLabels[variable]} scores`);
    }
    
    const gridData = [];
    const gridSize = 0.008; // Slightly larger grid for better performance
    const bandwidth = 0.005; // Much smaller bandwidth to preserve sharp differences
    
    // Generate grid points across the entire area (no circular boundary)
    for (let lat = AreaBounds.south; lat <= AreaBounds.north; lat += gridSize) {
        for (let lng = AreaBounds.west; lng <= AreaBounds.east; lng += gridSize) {
            
            // Calculate interpolated value using inverse distance weighting
            let interpolatedScore = calculateInterpolatedValue(lat, lng, filteredRestaurants, variable, bandwidth);
            
            // Fix normalization to preserve actual data variation
            let normalizedScore;
            if (scoreRange > 5) {
                // Standard normalization for good ranges
                normalizedScore = (interpolatedScore - minScore) / scoreRange;
            } else {
                // For compressed ranges, use actual restaurant min/max instead of interpolated values
                const directScores = filteredRestaurants.map(r => getScoreValue(r, variable)).filter(s => s > 0);
                if (directScores.length > 0) {
                    const dataMin = Math.min(...directScores);
                    const dataMax = Math.max(...directScores);
                    const dataRange = dataMax - dataMin;
                    if (dataRange > 0) {
                        normalizedScore = (interpolatedScore - dataMin) / dataRange;
                    } else {
                        normalizedScore = 0.5;
                    }
                } else {
                    normalizedScore = 0.5;
                }
            }
            
            // Apply contrast enhancement to spread values across full 0-1 range
            normalizedScore = Math.pow(normalizedScore, 0.7); // Gamma correction for better contrast
            normalizedScore = Math.max(0.05, Math.min(0.95, normalizedScore));
            
            gridData.push([lat, lng, normalizedScore]);
        }
    }
    
    return gridData;
}

// Calculate interpolated value with better distance weighting to preserve variation
function calculateInterpolatedValue(lat, lng, restaurants, variable, bandwidth) {
    let weightedSum = 0;
    let totalWeight = 0;
    const nearbyScores = [];
    const maxInfluenceDistance = 0.02; // Only consider restaurants within 2km
    
    restaurants.forEach(r => {
        const distance = Math.sqrt(Math.pow(lat - r.lat, 2) + Math.pow(lng - r.lng, 2));
        
        if (distance > maxInfluenceDistance) return; // Skip distant restaurants
        
        // Use more aggressive inverse distance weighting to preserve sharp differences
        let weight;
        if (distance < 0.0005) {
            weight = 10000; // Very close = very high weight
        } else if (distance < 0.002) {
            weight = 1 / Math.pow(distance, 3); // Cubic inverse for nearby restaurants
        } else {
            weight = 1 / Math.pow(distance, 2); // Quadratic inverse for farther restaurants
        }
        
        const restaurantScore = getScoreValue(r, variable);
        

        
        weightedSum += weight * restaurantScore;
        totalWeight += weight;
    });
    
    const interpolatedValue = totalWeight > 0 ? weightedSum / totalWeight : 0;
    

    
    return interpolatedValue;
}

function gaussianKernel(distance, bandwidth) {
    return Math.exp(-0.5 * Math.pow(distance / bandwidth, 2)) / (bandwidth * Math.sqrt(2 * Math.PI));
}

// ==================== FEATURE 2: EMD COMPARISON ====================
function renderComparisonPage() {
    const page = document.getElementById('comparison-page');
    const emds = Object.keys(stats.emd);
    page.innerHTML = `
        <div class="page-content">
            <div class="page-header">
                <h2>üìä ÏßÄÏó≠ ÌäπÏÑ± ÎπÑÍµê</h2>
                <p>Îëê ÏßÄÏó≠ÏùÑ ÏÑ†ÌÉùÌïòÏó¨ Ï£ºÏöî ÏÉÅÍ∂å ÏßÄÌëúÎ•º ÎπÑÍµê Î∂ÑÏÑùÌï©ÎãàÎã§.</p>
            </div>
            <div class="dimension-controls">
                <div class="control-group">
                    <label>ÎπÑÍµê ÎåÄÏÉÅ A (Îπ®Í∞ÑÏÉâ)</label>
                    <select id="emdA">${emds.map(e => `<option value="${e}">${e}</option>`).join('')}</select>
                </div>
                 <div class="control-group">
                    <label>ÎπÑÍµê ÎåÄÏÉÅ B (ÌååÎûÄÏÉâ)</label>
                    <select id="emdB">${emds.map((e,i) => `<option value="${e}" ${i===1 ? 'selected':''}>${e}</option>`).join('')}</select>
                </div>
            </div>
            <div id="emdComparisonContent">
                <div id="variableControls" class="variable-controls"></div>
                <div id="emdComparisonChart" class="chart-container"><canvas id="comparisonCanvas"></canvas></div>
            </div>
        </div>`;
    
    setupEmdComparison();
}

function setupEmdComparison() {
    const emdASelect = document.getElementById('emdA');
    const emdBSelect = document.getElementById('emdB');
    let selectedVariables = ['price_level', 'offering_quality_core', 'cleanliness_and_hygiene', 'service_staff_friendliness', 'atmosphere_formality'];
    
    function updateComparison() {
        renderEmdVariableControls(selectedVariables);
        renderEmdComparisonChart(emdASelect.value, emdBSelect.value, selectedVariables);
    }
    
    function renderEmdVariableControls(vars) {
        const container = document.getElementById('variableControls');
        container.innerHTML = vars.map(v => `
            <div class="variable-tag active">
                <span>${variableLabels[v]}</span>
                <button class="variable-remove" onclick="removeVariable('${v}')">&times;</button>
            </div>
        `).join('') + `
            <select id="addVariableSelect" onchange="addVariable()">
                <option value="">+ Î≥ÄÏàò Ï∂îÍ∞Ä</option>
                ${Object.entries(variableLabels)
                    .filter(([k]) => !vars.includes(k))
                    .map(([k,v]) => `<option value="${k}">${v}</option>`).join('')}
            </select>
        `;
    }
    
    window.removeVariable = (variable) => {
        selectedVariables = selectedVariables.filter(v => v !== variable);
        updateComparison();
    };
    
    window.addVariable = () => {
        const select = document.getElementById('addVariableSelect');
        if (select.value && !selectedVariables.includes(select.value)) {
            selectedVariables.push(select.value);
            updateComparison();
        }
    };
    
    emdASelect.addEventListener('change', updateComparison);
    emdBSelect.addEventListener('change', updateComparison);
    updateComparison();
}

function renderEmdComparisonChart(emdA, emdB, variables) {
    if (!emdA || !emdB || emdA === emdB) return;
    
    const dataA = stats.emd[emdA];
    const dataB = stats.emd[emdB];
    
    // Calculate responsive scale range based on actual data
    const allValues = variables.flatMap(v => [
        dataA[v] ? dataA[v].mean : 0,
        dataB[v] ? dataB[v].mean : 0
    ]);
    const minValue = Math.max(0, Math.min(...allValues) - 10);
    const maxValue = Math.min(100, Math.max(...allValues) + 10);
    
    const ctx = document.getElementById('comparisonCanvas').getContext('2d');
    if (charts.comparison) charts.comparison.destroy();
    
    charts.comparison = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: variables.map(v => variableLabels[v]),
            datasets: [
                {
                    label: emdA,
                    data: variables.map(v => dataA[v] ? dataA[v].mean : 0),
                    backgroundColor: 'rgba(231, 76, 60, 0.7)',
                    borderColor: 'rgba(231, 76, 60, 1)',
                    borderWidth: 2
                },
                {
                    label: emdB,
                    data: variables.map(v => dataB[v] ? dataB[v].mean : 0),
                    backgroundColor: 'rgba(52, 152, 219, 0.7)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: { 
                x: { 
                    min: minValue, 
                    max: maxValue,
                    ticks: { 
                        font: { size: 14, weight: 'bold' },
                        color: '#333'
                    },
                    title: {
                        display: true,
                        text: 'Ï†êÏàò',
                        font: { size: 16, weight: 'bold' },
                        color: '#333'
                    }
                },
                y: {
                    ticks: { 
                        font: { size: 12, weight: 'bold' },
                        color: '#333'
                    }
                }
            },
            plugins: {
                legend: { 
                    position: 'top',
                    labels: {
                        font: { size: 14, weight: 'bold' }
                    }
                },
                tooltip: {
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 12, weight: 'normal' },
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.x.toFixed(1)}Ï†ê`;
                        }
                    }
                }
            }
        }
    });
}

// ==================== FEATURE 3 & 4: SHOP DETAIL & COMPARISON ====================
function showShopDetailModal(shop) {
    document.getElementById('shopModalTitle').textContent = `${shop.name} ÏÉÅÏÑ∏ Î∂ÑÏÑù`;
    renderShopDetail(shop);
    renderShopComparison(shop);
    document.getElementById('shopModal').style.display = 'flex';
}

function renderShopDetail(shop) {
    const container = document.getElementById('shopDetailSection');
    const cityAvgs = stats.city;
    const localAvgs = shop.emd ? stats.emd[shop.emd] : {};
    
    let selectedVariables = ['price_level', 'offering_quality_core', 'taste_spiciness', 'cleanliness_and_hygiene', 'service_staff_friendliness'];
    
    function updateVariableDisplay() {
        const variableList = document.getElementById('variableList');
        variableList.innerHTML = selectedVariables.map(v => {
            const shopScore = getScoreValue(shop, v);
            const cityScore = cityAvgs[v] ? cityAvgs[v].mean : 0;
            const localScore = localAvgs[v] ? localAvgs[v].mean : 0;
            const components = (shop.universal_scores[v] || shop.subspace_scores?.['Food & Beverage Taste']?.[v])?.components || [];
            
            return `
            <div class="variable-section" style="margin-bottom: 1rem; border: 1px solid var(--gray); border-radius: 8px; padding: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <h4 style="font-weight: 900; font-size: 1rem; color: var(--primary);">${variableLabels[v]}</h4>
                    <button class="variable-remove" onclick="removeVariable('${v}')" style="background: var(--danger); color: white; border: none; border-radius: 3px; width: 20px; height: 20px; cursor: pointer; font-size: 0.8rem; font-weight: 900;">‚àí</button>
                </div>
                <div class="point-line-chart">
                    <div class="point-line">
                        <div class="point-marker city" style="left: ${cityScore}%;" onmouseover="showKernelDensity('${v}', 'city')" onmouseout="hideKernelDensity()">
                            <div class="point-label city">Í¥ëÎ™ÖÏãú ÌèâÍ∑†</div>
                        </div>
                        <div class="point-marker local" style="left: ${localScore}%;" onmouseover="showKernelDensity('${v}', 'local')" onmouseout="hideKernelDensity()">
                            <div class="point-label local">${shop.emd} ÌèâÍ∑†</div>
                        </div>
                        <div class="point-marker shop" style="left: ${shopScore}%;" onmouseover="showKernelDensity('${v}', 'shop')" onmouseout="hideKernelDensity()">
                            <div class="point-label shop">${shop.name}</div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.7rem; color: #666; font-weight: 700;">
                        <span>0</span><span>25</span><span>50</span><span>75</span><span>100</span>
                    </div>
                </div>
                <div class="component-detail" style="margin-top: 0.5rem; font-size: 0.8rem;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem;">
                        <div>
                            ${components.map(c => `
                                <div style="display: flex; justify-content: space-between; margin: 0.3rem 0; padding: 0.3rem; background: var(--bg); border-radius: 4px;">
                                   <span style="font-weight: 800;">${c.component_name}</span>
                                   <span style="color: var(--primary); font-weight: 800;">${c.point_score.toFixed(1)}Ï†ê (${(c.weight * 100).toFixed(0)}%)</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="kernel-density-chart">
                            <canvas id="kde-${v}" width="150" height="80"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }).join('');
        
        // Redraw kernel density plots
        selectedVariables.forEach(v => {
            const components = (shop.universal_scores[v] || shop.subspace_scores?.['Food & Beverage Taste']?.[v])?.components;
            if (components) {
                setTimeout(() => drawKernelDensity(`kde-${v}`, components), 100);
            }
        });
        
        // Update add variable dropdown
        const availableVars = Object.keys(variableLabels).filter(v => !selectedVariables.includes(v));
        const addDropdown = document.getElementById('addVariableDropdown');
        addDropdown.innerHTML = `<option value="">+ Î≥ÄÏàò Ï∂îÍ∞Ä</option>` + 
            availableVars.map(v => `<option value="${v}">${variableLabels[v]}</option>`).join('');
    }
    
    container.innerHTML = `
        <h3 style="font-weight: 900; margin-bottom: 0.5rem;">üè™ Í∞ÄÍ≤å Î∂ÑÏÑù</h3>
        <p style="margin-bottom: 0.3rem; font-weight: 800;"><strong>${shop.address}</strong></p>
        <p style="margin-bottom: 1rem; font-style: italic; color: #666; font-size: 0.9rem;">${shop.latent_summary}</p>
        
        <select id="addVariableDropdown" onchange="addVariable()" style="width: 100%; padding: 0.5rem; margin-bottom: 1rem; border: 2px solid var(--success); border-radius: 6px; font-weight: 800; background: var(--success); color: white;">
            <option value="">+ Î≥ÄÏàò Ï∂îÍ∞Ä</option>
        </select>
        
        <div style="margin-bottom: 1rem; padding: 0.7rem; background: #f8f9fa; border-radius: 6px; font-size: 0.85rem;">
            <p style="font-weight: 800; margin-bottom: 0.3rem;">Îã§Î•∏ ÏöîÏù∏Îì§ÏùÑ ÌôïÏù∏ÌïòÎ†§Î©¥ <span style="color: var(--danger); font-weight: 900;">‚àí</span>Î•º ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî</p>
            <small style="color: #666; font-weight: 700;">ÎßàÏª§Ïóê ÎßàÏö∞Ïä§Î•º Ïò¨Î¶¨Î©¥ ÏÉÅÏÑ∏ Î∂ÑÌè¨Î•º ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.</small>
        </div>
        
        <div id="variableList"></div>
        <div id="kernelHoverInfo" style="position: fixed; background: rgba(0,0,0,0.8); color: white; padding: 0.5rem; border-radius: 4px; font-size: 0.8rem; pointer-events: none; z-index: 9999; display: none; font-weight: 700;"></div>
    `;
    
    window.removeVariable = (variable) => {
        selectedVariables = selectedVariables.filter(v => v !== variable);
        updateVariableDisplay();
        
        // Update instruction text
        const instruction = container.querySelector('p');
        if (selectedVariables.length > 0) {
            instruction.innerHTML = 'Îã§Î•∏ ÏöîÏù∏Îì§ÏùÑ ÌôïÏù∏ÌïòÎ†§Î©¥ <span style="color: var(--danger); font-weight: 900;">‚àí</span>Î•º ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî';
        } else {
            instruction.innerHTML = 'Î≥ÄÏàòÎ•º Ï∂îÍ∞ÄÌïòÎ†§Î©¥ <span style="color: var(--success); font-weight: 900;">+</span> ÎìúÎ°≠Îã§Ïö¥ÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî';
        }
    };
    
    window.addVariable = () => {
        const dropdown = document.getElementById('addVariableDropdown');
        if (dropdown.value && !selectedVariables.includes(dropdown.value)) {
            selectedVariables.unshift(dropdown.value); // Add to beginning instead of end
            updateVariableDisplay();
            dropdown.value = '';
        }
    };
    
    window.showKernelDensity = (variable, type) => {
        const hoverInfo = document.getElementById('kernelHoverInfo');
        const components = (shop.universal_scores[variable] || shop.subspace_scores?.['Food & Beverage Taste']?.[variable])?.components || [];
        
        if (type === 'shop' && components.length > 0) {
            hoverInfo.innerHTML = `
                <strong>${variableLabels[variable]} Íµ¨ÏÑ±ÏöîÏÜå:</strong><br>
                ${components.map(c => `${c.component_name}: ${c.point_score.toFixed(1)}Ï†ê (${(c.weight * 100).toFixed(0)}%)`).join('<br>')}
            `;
            hoverInfo.style.display = 'block';
            
            document.addEventListener('mousemove', (e) => {
                hoverInfo.style.left = e.pageX + 10 + 'px';
                hoverInfo.style.top = e.pageY + 10 + 'px';
            });
        }
    };
    
    window.hideKernelDensity = () => {
        document.getElementById('kernelHoverInfo').style.display = 'none';
    };
    
    updateVariableDisplay();
}

function renderShopComparison(shop1, shop2 = null) {
    const container = document.getElementById('shopComparisonSection');
    
    if (shop2) {
        // Direct comparison mode (from "Îã§Î•∏ Í∞ÄÍ≤å Î∂ÑÏÑù" button)
        container.innerHTML = `
            <h3>‚öîÔ∏è Í∞ÄÍ≤å ÏßÅÏ†ë ÎπÑÍµê</h3>
            <div id="radarContainer" class="radar-container">
                <canvas id="radarChart"></canvas>
            </div>
        `;
        drawRadarChart(shop1, shop2);
    } else {
        // Original comparison mode
        container.innerHTML = `
            <h3>‚öîÔ∏è Í≤ΩÏüÅ Í∞ÄÍ≤åÏôÄ ÎπÑÍµê</h3>
            <button id="compareBtn" class="btn btn-primary">ÏÉàÎ°úÏö¥ Í∞ÄÍ≤åÏôÄ ÎπÑÍµêÌïòÍ∏∞</button>
            <div id="radarContainer" class="radar-container" style="display:none;">
                <canvas id="radarChart"></canvas>
            </div>
            <p id="comparisonInstructions">Î≤ÑÌäºÏùÑ ÎàåÎü¨ÏÑú Ïù¥ ÏßÄÏó≠Ïùò Îã§Î•∏ Í∞ÄÍ≤åÏôÄ ÎπÑÍµêÌï¥Î≥¥ÏÑ∏Ïöî.</p>
        `;

        document.getElementById('compareBtn').onclick = () => {
            const potentialCompetitors = allRestaurants.filter(r => 
                r.key !== shop1.key && 
                r.emd === shop1.emd && 
                r.avg_confidence >= 70
            );
            if (potentialCompetitors.length > 0) {
                const competitor = potentialCompetitors[Math.floor(Math.random() * potentialCompetitors.length)];
                document.getElementById('radarContainer').style.display = 'block';
                document.getElementById('comparisonInstructions').style.display = 'none';
                drawRadarChart(shop1, competitor);
            } else {
                document.getElementById('comparisonInstructions').textContent = 'Ïù¥ ÏßÄÏó≠Ïóê ÎπÑÍµêÌï† Îã§Î•∏ Í∞ÄÍ≤åÍ∞Ä ÏóÜÏäµÎãàÎã§.';
            }
        };
    }
}

function drawRadarChart(shop1, shop2) {
    if (charts.radar) charts.radar.destroy();
    const ctx = document.getElementById('radarChart').getContext('2d');
    const subcatAvg = stats.subcategory[shop1.subcategory] || {};

    const radarLabels = ['Í∞ÄÍ≤©', 'ÌíàÏßà', 'ÎèÖÌäπÏÑ±', 'Ï≤≠Í≤∞ÎèÑ', 'ÏπúÏ†àÎèÑ', 'Î∂ÑÏúÑÍ∏∞'];
    const radarVars = ['price_level', 'offering_quality_core', 'offering_uniqueness_and_novelty', 'cleanliness_and_hygiene', 'service_staff_friendliness', 'atmosphere_formality'];

    charts.radar = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: radarLabels,
            datasets: [
                {
                    label: shop1.name,
                    data: radarVars.map(v => getScoreValue(shop1, v)),
                    fill: true,
                    backgroundColor: 'rgba(52, 152, 219, 0.2)',
                    borderColor: 'rgb(52, 152, 219)',
                    pointBackgroundColor: 'rgb(52, 152, 219)',
                    borderWidth: 3,
                    pointRadius: 6
                },
                {
                    label: shop2.name,
                    data: radarVars.map(v => getScoreValue(shop2, v)),
                    fill: true,
                    backgroundColor: 'rgba(231, 76, 60, 0.2)',
                    borderColor: 'rgb(231, 76, 60)',
                    pointBackgroundColor: 'rgb(231, 76, 60)',
                    borderWidth: 3,
                    pointRadius: 6
                },
                {
                    label: `${shop1.subcategory} ÌèâÍ∑†`,
                    data: radarVars.map(v => subcatAvg[v] ? subcatAvg[v].mean : 0),
                    fill: false,
                    borderColor: 'rgba(50, 50, 50, 0.8)',
                    pointBackgroundColor: 'rgba(50, 50, 50, 0.8)',
                    borderDash: [5, 5],
                    borderWidth: 3,
                    pointRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { 
                r: { 
                    beginAtZero: true, 
                    max: 100,
                    ticks: { 
                        stepSize: 20,
                        font: { size: 12, weight: 'bold' },
                        color: '#333'
                    },
                    pointLabels: {
                        font: { size: 14, weight: 'bold' },
                        color: '#333'
                    },
                    grid: {
                        color: '#ddd'
                    },
                    angleLines: {
                        color: '#ddd'
                    }
                } 
            },
            plugins: {
                legend: {
                    labels: {
                        font: { size: 12, weight: 'bold' }
                    }
                },
                tooltip: {
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 12, weight: 'normal' }
                }
            }
        }
    });
}

// ==================== FEATURE 5: FRANCHISE ANALYSIS ====================
function renderFranchisePage() {
    const page = document.getElementById('franchise-page');
    const subcategories = Object.keys(stats.subcategory);
    
    page.innerHTML = `
        <div class="page-content">
            <div class="page-header">
                <h2>üçΩÔ∏è ÏùåÏãùÏ†ê Ïú†Ìòï Î∂ÑÏÑù</h2>
                <p>ÏùåÏãùÏ†ê Ïú†ÌòïÎ≥Ñ Îß§Ïû• ÌòÑÌô©Í≥º ÌäπÏÑ±ÏùÑ Î∂ÑÏÑùÌï©ÎãàÎã§.</p>
            </div>
            <div class="control-group">
                <label for="subcategorySelect">ÏùåÏãùÏ†ê Ïú†Ìòï ÏÑ†ÌÉù</label>
                <select id="subcategorySelect">
                    <option value="">ÏùåÏãùÏ†ê Ïú†ÌòïÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                    ${subcategories.map(s => `<option value="${s}" ${s === 'ÌïúÏãù' ? 'selected' : ''}>${s}</option>`).join('')}
                </select>
            </div>
            <div id="franchiseContent"></div>
        </div>
    `;
    
    document.getElementById('subcategorySelect').addEventListener('change', (e) => {
        if (e.target.value) updateSubcategoryAnalysis(e.target.value);
    });
    
    // Auto-load ÌïúÏãù by default
    setTimeout(() => updateSubcategoryAnalysis('ÌïúÏãù'), 100);
}

function updateSubcategoryAnalysis(subcategory) {
    const subcategoryShops = allRestaurants.filter(r => r.subcategory === subcategory);
    if (subcategoryShops.length === 0) {
        document.getElementById('franchiseContent').innerHTML = '<p>Ìï¥Îãπ ÏùåÏãùÏ†ê Ïú†Ìòï Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
        return;
    }
    
    const subcategoryAvg = stats.subcategory[subcategory];
    const outliers = subcategoryShops.map(shop => {
        const deviations = Object.keys(variableLabels).map(variable => {
            const shopValue = getScoreValue(shop, variable);
            const avgValue = subcategoryAvg[variable] ? subcategoryAvg[variable].mean : 0;
            return {
                variable: variable,
                deviation: Math.abs(shopValue - avgValue),
                value: shopValue,
                avg: avgValue
            };
        }).sort((a, b) => b.deviation - a.deviation);
        
        return { shop: shop, maxDeviation: deviations[0] };
    }).sort((a, b) => b.maxDeviation.deviation - a.maxDeviation.deviation);
    
    const content = document.getElementById('franchiseContent');
    content.innerHTML = `
        <div class="comparison-layout">
            <div class="comparison-panel">
                <h3>üéØ Í∞ÄÏû• Ï∞®Î≥ÑÌôîÎêú Îß§Ïû•</h3>
                <div style="max-height: 600px; overflow-y: auto;">
                    ${outliers.slice(0, 8).map(o => `
                        <div class="outlier-item" onclick="showSubcategoryComparison('${o.shop.key}', '${subcategory}')">
                            <h4>${o.shop.name}</h4>
                            <p style="color: #666; margin: 0.5rem 0;">${o.shop.address}</p>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span><strong>${variableLabels[o.maxDeviation.variable]}</strong></span>
                                <span style="color: var(--danger); font-weight: 600;">
                                    ${o.maxDeviation.value.toFixed(1)}Ï†ê 
                                    (ÌèâÍ∑†: ${o.maxDeviation.avg.toFixed(1)}Ï†ê)
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            <div class="comparison-panel" id="franchiseComparison">
                <p style="text-align: center; color: #666; margin-top: 2rem;">Îß§Ïû•ÏùÑ ÏÑ†ÌÉùÌïòÏó¨ ÏÉÅÏÑ∏ ÎπÑÍµêÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.</p>
            </div>
        </div>
    `;
}

window.showSubcategoryComparison = (shopKey, subcategory) => {
    const shop = allRestaurants.find(r => r.key === shopKey);
    const subcategoryAvg = stats.subcategory[subcategory];
    
    const container = document.getElementById('franchiseComparison');
    const varsToDisplay = ['price_level', 'offering_quality_core', 'cleanliness_and_hygiene', 'service_staff_friendliness', 'atmosphere_formality', 'operational_speed_and_efficiency'];
    
    container.innerHTML = `
        <h3>üìà ÏùåÏãùÏ†ê Ïú†Ìòï ÌèâÍ∑†Í≥º ÎπÑÍµê</h3>
        <h4>${shop.name}</h4>
        <p style="margin-bottom: 1.5rem; color: #666;">${shop.address}</p>
        <div style="margin-bottom: 1rem;">
            <small style="color: #666;">
                <span style="color: var(--info);">‚ñ†</span> ${shop.name} &nbsp;
                <span style="color: #333;">‚ñ†</span> ${subcategory} ÌèâÍ∑†
            </small>
        </div>
    ` + varsToDisplay.map(v => {
        const shopScore = getScoreValue(shop, v);
        const subcategoryScore = subcategoryAvg[v] ? subcategoryAvg[v].mean : 0;
        const diff = shopScore - subcategoryScore;
        return `
        <div class="point-line-chart" style="margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="font-weight: 800;">${variableLabels[v]}</span>
                <span style="color: ${diff > 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 700;">
                    ${diff > 0 ? '+' : ''}${diff.toFixed(1)}
                </span>
            </div>
            <div class="point-line">
                <div class="point-marker city" style="left: ${subcategoryScore}%;">
                    <div class="point-label city">${subcategory} ÌèâÍ∑†</div>
                </div>
                <div class="point-marker shop" style="left: ${shopScore}%;">
                    <div class="point-label shop">${shop.name}</div>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.7rem; color: #666; font-weight: 700;">
                <span>0</span><span>25</span><span>50</span><span>75</span><span>100</span>
            </div>
        </div>
        `;
    }).join('');
};

// ==================== FEATURE 7: RESTAURANT TYPE MAP ====================
function renderTypeMapPage() {
    const page = document.getElementById('typemap-page');
    page.innerHTML = `
        <div class="page-content">
            <div class="page-header">
                <h2>üó∫Ô∏è ÏùåÏãùÏ†ê Ïú†Ìòï ÏßÄÎèÑ</h2>
                <p>Í∞Å ÏóÖÏ¢ÖÏùò ÌäπÏÑ±ÏùÑ 2Ï∞®Ïõê ÏßÄÎèÑÎ°ú ÏãúÍ∞ÅÌôîÌïòÏó¨ Ïú†ÏÇ¨ÏÑ±ÏùÑ Î∂ÑÏÑùÌï©ÎãàÎã§.</p>
            </div>
            <div class="dimension-controls">
                <div class="dimension-control">
                    <label>XÏ∂ï Î≥ÄÏàò</label>
                    <select id="typeMapX">
                        ${Object.entries(variableLabels).map(([k,v]) => 
                            `<option value="${k}" ${k === 'taste_spiciness' ? 'selected' : ''}>${v}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="dimension-control">
                    <label>YÏ∂ï Î≥ÄÏàò</label>
                    <select id="typeMapY">
                        ${Object.entries(variableLabels).map(([k,v]) => 
                            `<option value="${k}" ${k === 'price_level' ? 'selected' : ''}>${v}</option>`
                        ).join('')}
                    </select>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="typeMapChart"></canvas>
            </div>
        </div>
    `;
    
    document.getElementById('typeMapX').addEventListener('change', updateTypeMap);
    document.getElementById('typeMapY').addEventListener('change', updateTypeMap);
    updateTypeMap();
}

function updateTypeMap() {
    const xVar = document.getElementById('typeMapX').value;
    const yVar = document.getElementById('typeMapY').value;
    
    const subcategoryData = {};
    const subcategories = [...new Set(allRestaurants.map(r => r.subcategory))];
    
    subcategories.forEach(subcategory => {
        const subcatRestaurants = allRestaurants.filter(r => r.subcategory === subcategory);
        if (subcatRestaurants.length > 0) {
            const xValues = subcatRestaurants.map(r => getScoreValue(r, xVar));
            const yValues = subcatRestaurants.map(r => getScoreValue(r, yVar));
            
            subcategoryData[subcategory] = {
                x: xValues.reduce((a, b) => a + b, 0) / xValues.length,
                y: yValues.reduce((a, b) => a + b, 0) / yValues.length,
                count: subcatRestaurants.length
            };
        }
    });
    
    // Calculate responsive scale ranges
    const allXValues = Object.values(subcategoryData).map(d => d.x);
    const allYValues = Object.values(subcategoryData).map(d => d.y);
    const xMin = Math.max(0, Math.min(...allXValues) - 5);
    const xMax = Math.min(100, Math.max(...allXValues) + 5);
    const yMin = Math.max(0, Math.min(...allYValues) - 5);
    const yMax = Math.min(100, Math.max(...allYValues) + 5);
    
    const ctx = document.getElementById('typeMapChart').getContext('2d');
    if (charts.typeMap) charts.typeMap.destroy();
    
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'];
    
    charts.typeMap = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: Object.entries(subcategoryData).map(([subcategory, data], index) => ({
                label: `${subcategory} (${data.count}Í∞ú)`,
                data: [{x: data.x, y: data.y}],
                backgroundColor: colors[index % colors.length],
                borderColor: colors[index % colors.length],
                borderWidth: 2,
                pointRadius: Math.sqrt(data.count) * 2 + 5,
                pointHoverRadius: Math.sqrt(data.count) * 2 + 8
            }))
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: { 
                        display: true, 
                        text: variableLabels[xVar],
                        font: { size: 16, weight: 'bold' },
                        color: '#333'
                    },
                    ticks: { 
                        font: { size: 14, weight: 'bold' },
                        color: '#333'
                    },
                    min: xMin, max: xMax
                },
                y: {
                    title: { 
                        display: true, 
                        text: variableLabels[yVar],
                        font: { size: 16, weight: 'bold' },
                        color: '#333'
                    },
                    ticks: { 
                        font: { size: 14, weight: 'bold' },
                        color: '#333'
                    },
                    min: yMin, max: yMax
                }
            },
            plugins: {
                legend: {
                    labels: {
                        font: { size: 12, weight: 'bold' }
                    }
                },
                tooltip: {
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 12, weight: 'normal' },
                    callbacks: {
                        label: function(context) {
                            const subcategory = context.dataset.label.split(' (')[0];
                            return `${subcategory}: (${context.parsed.x.toFixed(1)}, ${context.parsed.y.toFixed(1)})`;
                        }
                    }
                }
            }
        }
    });
}

// ==================== FEATURE 8: STRATEGY MAP ====================
function renderStrategyMapPage() {
    const page = document.getElementById('strategymap-page');
    
    // Debug: log subcategory stats
    console.log('Available subcategories and counts:');
    const subcategoryCounts = {};
    allRestaurants.forEach(r => {
        if (r.subcategory) {
            subcategoryCounts[r.subcategory] = (subcategoryCounts[r.subcategory] || 0) + 1;
        }
    });
    console.table(subcategoryCounts);
    const emds = Object.keys(stats.emd);
    const randomEmd = emds[Math.floor(Math.random() * emds.length)];
    
    page.innerHTML = `
        <div class="page-content">
            <div class="page-header">
                <h2>üéØ Í∞ÄÍ≤åÎ≥Ñ Ï†ÑÎûµ ÏßÄÎèÑ</h2>
                <p>ÏÑ†ÌÉùÌïú ÏùåÏãùÏ†ê Ïú†ÌòïÏùò Í∞ÄÍ≤åÎì§ÏùÑ Î≥ÄÏàòÎ≥ÑÎ°ú ÏãúÍ∞ÅÌôîÌïòÏó¨ Ìè¨ÏßÄÏÖîÎãùÏùÑ Î∂ÑÏÑùÌï©ÎãàÎã§. Ï†êÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ ÏÉÅÏÑ∏Ìïú Í∞ÄÍ≤å Ï†ïÎ≥¥Î•º ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.</p>
            </div>
            <div class="dimension-controls" style="gap: 0.5rem;">
                <div class="dimension-control">
                    <label style="font-weight: 800; color: var(--primary); font-size: 1.1rem; margin-bottom: 0.8rem;">ÏùåÏãùÏ†ê Ïú†Ìòï</label>
                    <select id="strategySubcategory" style="padding: 1rem; border: 2px solid var(--primary); border-radius: 12px; font-size: 1rem; background: linear-gradient(135deg, var(--white), #f8f9fa); transition: all 0.3s; font-weight: 700; box-shadow: 0 4px 12px rgba(102,126,234,0.2);">
                        ${[...new Set(allRestaurants.map(r => r.subcategory))].sort().map(s => `<option value="${s}" ${s === 'ÌïúÏãù' ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>
                </div>
                <div class="dimension-control">
                    <label style="font-weight: 800; color: var(--primary); font-size: 1.1rem; margin-bottom: 0.8rem;">XÏ∂ï Î≥ÄÏàò</label>
                    <select id="strategyX" style="padding: 1rem; border: 2px solid var(--secondary); border-radius: 12px; font-size: 1rem; background: linear-gradient(135deg, var(--white), #f8f9fa); transition: all 0.3s; font-weight: 700; box-shadow: 0 4px 12px rgba(118,75,162,0.2);">
                        ${Object.entries(variableLabels).map(([k,v]) => 
                            `<option value="${k}" ${k === 'price_level' ? 'selected' : ''}>${v}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="dimension-control">
                    <label style="font-weight: 800; color: var(--primary); font-size: 1.1rem; margin-bottom: 0.8rem;">YÏ∂ï Î≥ÄÏàò</label>
                    <select id="strategyY" style="padding: 1rem; border: 2px solid var(--success); border-radius: 12px; font-size: 1rem; background: linear-gradient(135deg, var(--white), #f8f9fa); transition: all 0.3s; font-weight: 700; box-shadow: 0 4px 12px rgba(46,204,113,0.2);">
                        ${Object.entries(variableLabels).map(([k,v]) => 
                            `<option value="${k}" ${k === 'offering_quality_core' ? 'selected' : ''}>${v}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="dimension-control">
                    <label style="font-weight: 800; color: var(--primary); font-size: 1.1rem; margin-bottom: 0.8rem;">Îã§Î•∏ Í∞ÄÍ≤å Î∂ÑÏÑù</label>
                    <button id="analyzeOtherShop" class="btn btn-primary" style="width: 100%; margin: 0; padding: 1rem; font-size: 1rem;">Îã§Î•∏ Í∞ÄÍ≤å Î∂ÑÏÑù</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="strategyChart"></canvas>
            </div>
            <div id="strategyHoverInfo" style="margin-top: 2rem; padding: 1.5rem; background: var(--bg); border-radius: 12px; min-height: 100px; max-height: 400px; overflow-y: auto;"></div>
        </div>
    `;
    
    document.getElementById('strategySubcategory').addEventListener('change', updateStrategyMap);
    document.getElementById('strategyX').addEventListener('change', updateStrategyMap);
    document.getElementById('strategyY').addEventListener('change', updateStrategyMap);
    
    // Add event listener for "Îã§Î•∏ Í∞ÄÍ≤å Î∂ÑÏÑù" button - updates plot with different restaurants
    document.getElementById('analyzeOtherShop').addEventListener('click', () => {
        const subcategory = document.getElementById('strategySubcategory').value;
        if (subcategory) {
            // Simply refresh the strategy map with different random restaurants
            updateStrategyMap();
        }
    });
    
    // Show content immediately with random area
    setTimeout(updateStrategyMap, 100);
}

function updateStrategyMap() {
    const subcategory = document.getElementById('strategySubcategory').value;
    if (!subcategory) return;
    
    const xVar = document.getElementById('strategyX').value;
    const yVar = document.getElementById('strategyY').value;
    
    // Debug: Log all restaurants with this subcategory
    const allSubcategoryRestaurants = allRestaurants.filter(r => r.subcategory === subcategory);
    console.log(`Total ${subcategory} restaurants: ${allSubcategoryRestaurants.length}`);
    
    const subcategoryRestaurants = allRestaurants
        .filter(r => {
            const subcategoryMatch = r.subcategory === subcategory;
            const confidencePass = r.avg_confidence >= 70; // Lowered from 80 to 70
            return subcategoryMatch && confidencePass;
        })
        .sort(() => 0.5 - Math.random())
        .slice(0, 50); // Increased from 40 to 50
    
    console.log(`Strategy map for ${subcategory}: found ${subcategoryRestaurants.length} restaurants with confidence >= 70`);
    
    if (subcategoryRestaurants.length === 0) {
        console.warn(`No restaurants found for subcategory: ${subcategory}`);
        // Show placeholder message
        document.getElementById('strategyHoverInfo').innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #666;">
                <h4>Îç∞Ïù¥ÌÑ∞ Î∂ÄÏ°±</h4>
                <p>${subcategory} Ïú†ÌòïÏùò Ï∂©Î∂ÑÌïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
            </div>
        `;
        return;
    }
    
    // Calculate responsive scale ranges for better visualization
    const xValues = subcategoryRestaurants.map(r => getScoreValue(r, xVar));
    const yValues = subcategoryRestaurants.map(r => getScoreValue(r, yVar));
    const xMin = Math.max(0, Math.min(...xValues) - 5);
    const xMax = Math.min(100, Math.max(...xValues) + 5);
    const yMin = Math.max(0, Math.min(...yValues) - 5);
    const yMax = Math.min(100, Math.max(...yValues) + 5);
    
    const ctx = document.getElementById('strategyChart').getContext('2d');
    if (charts.strategy) charts.strategy.destroy();
    
            // Create diverse colors for different restaurants
        const colors = [
            'rgba(231, 76, 60, 0.8)',   // Red
            'rgba(52, 152, 219, 0.8)',  // Blue
            'rgba(46, 204, 113, 0.8)',  // Green
            'rgba(155, 89, 182, 0.8)',  // Purple
            'rgba(241, 196, 15, 0.8)',  // Yellow
            'rgba(230, 126, 34, 0.8)',  // Orange
            'rgba(52, 73, 94, 0.8)',    // Dark Gray
            'rgba(26, 188, 156, 0.8)',  // Turquoise
            'rgba(142, 68, 173, 0.8)',  // Dark Purple
            'rgba(39, 174, 96, 0.8)'    // Dark Green
        ];
        
        charts.strategy = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    data: subcategoryRestaurants.map((r, index) => ({
                        x: getScoreValue(r, xVar),
                        y: getScoreValue(r, yVar),
                        restaurant: r,
                        backgroundColor: colors[index % colors.length],
                        borderColor: colors[index % colors.length].replace('0.8', '1.0'),
                        pointRadius: 10,
                        pointHoverRadius: 15
                    })),
                    showLine: false,
                    pointBackgroundColor: function(context) {
                        const index = context.dataIndex;
                        return colors[index % colors.length];
                    },
                    pointBorderColor: function(context) {
                        const index = context.dataIndex;
                        return colors[index % colors.length].replace('0.8', '1.0');
                    },
                    pointRadius: 10,
                    pointHoverRadius: 15,
                    borderWidth: 3
                }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: { 
                        display: true, 
                        text: variableLabels[xVar],
                        font: { size: 16, weight: 'bold' },
                        color: '#333'
                    },
                    ticks: { 
                        font: { size: 14, weight: 'bold' },
                        color: '#333'
                    },
                    min: xMin, max: xMax
                },
                y: {
                    title: { 
                        display: true, 
                        text: variableLabels[yVar],
                        font: { size: 16, weight: 'bold' },
                        color: '#333'
                    },
                    ticks: { 
                        font: { size: 14, weight: 'bold' },
                        color: '#333'
                    },
                    min: yMin, max: yMax
                }
            },
            plugins: {
                legend: { display: false }, // Remove legend as requested
                tooltip: {
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 12, weight: 'normal' },
                    callbacks: {
                        title: function(context) {
                            const r = context[0].raw.restaurant;
                            return r.name;
                        },
                        label: function(context) {
                            return `${variableLabels[xVar]}: ${context.parsed.x.toFixed(1)}`;
                        },
                        afterLabel: function(context) {
                            const r = context.raw.restaurant;
                            return [
                                `${variableLabels[yVar]}: ${context.parsed.y.toFixed(1)}`,
                                '',
                                r.latent_summary ? r.latent_summary.substring(0, 80) + '...' : ''
                            ];
                        }
                    }
                }
            },
            onHover: (event, activeElements) => {
                if (activeElements.length > 0) {
                    const dataIndex = activeElements[0].index;
                    const restaurant = subcategoryRestaurants[dataIndex];
                    showStrategyHoverInfo(restaurant, xVar, yVar);
                }
            },
            onClick: (event, activeElements) => {
                if (activeElements.length > 0) {
                    const dataIndex = activeElements[0].index;
                    const restaurant = subcategoryRestaurants[dataIndex];
                    showShopDetailModal(restaurant); // Make dots clickable like in ÏßÄÎèÑÎ∂ÑÏÑù
                }
            }
        }
    });
}

function showStrategyHoverInfo(restaurant, xVar, yVar) {
    const info = document.getElementById('strategyHoverInfo');
    
    const xComponents = restaurant.universal_scores[xVar]?.components || [];
    const yComponents = restaurant.universal_scores[yVar]?.components || [];
    
    info.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2rem; height: auto; max-height: 350px;">
            <div style="min-height: 200px;">
                <h4 style="color: var(--primary); font-weight: 900;">${restaurant.name}</h4>
                <p style="color: #666; font-weight: 700;">${restaurant.address}</p>
                <p style="margin-top: 1rem; color: #555; line-height: 1.5;">${restaurant.latent_summary}</p>
            </div>
            <div style="min-height: 200px; max-height: 300px; overflow-y: auto;">
                <h5 style="color: var(--secondary); font-weight: 800;">${variableLabels[xVar]} Î∂ÑÌè¨</h5>
                <div style="height: 100px; margin: 0.5rem 0;">
                    <canvas id="xDensity" width="200" height="80" style="max-width: 100%; height: auto;"></canvas>
                </div>
                <div style="font-size: 0.8rem;">
                    ${xComponents.map(c => `
                        <div style="display: flex; justify-content: space-between; margin: 0.3rem 0; padding: 0.2rem; background: #f8f9fa; border-radius: 4px;">
                            <span style="font-weight: 700; font-size: 0.75rem;">${c.component_name}</span>
                            <span style="color: var(--primary); font-weight: 800; font-size: 0.75rem;">${c.point_score.toFixed(1)} (${(c.weight * 100).toFixed(0)}%)</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            <div style="min-height: 200px; max-height: 300px; overflow-y: auto;">
                <h5 style="color: var(--secondary); font-weight: 800;">${variableLabels[yVar]} Î∂ÑÌè¨</h5>
                <div style="height: 100px; margin: 0.5rem 0;">
                    <canvas id="yDensity" width="200" height="80" style="max-width: 100%; height: auto;"></canvas>
                </div>
                <div style="font-size: 0.8rem;">
                    ${yComponents.map(c => `
                        <div style="display: flex; justify-content: space-between; margin: 0.3rem 0; padding: 0.2rem; background: #f8f9fa; border-radius: 4px;">
                            <span style="font-weight: 700; font-size: 0.75rem;">${c.component_name}</span>
                            <span style="color: var(--primary); font-weight: 800; font-size: 0.75rem;">${c.point_score.toFixed(1)} (${(c.weight * 100).toFixed(0)}%)</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
    
    setTimeout(() => {
        try {
            drawKernelDensityFixed('xDensity', xComponents);
            drawKernelDensityFixed('yDensity', yComponents);
        } catch (e) {
            console.warn('Chart rendering error:', e);
        }
    }, 50);
}

// ==================== UTILITY FUNCTIONS ====================
function createControlPanel() {
    const panel = document.createElement('div');
    panel.className = 'control-panel';
    return panel;
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    Object.values(charts).forEach(chart => {
        if (chart && chart.destroy) chart.destroy();
    });
    charts = {};
}

function toggleVisibility(elementId) {
    const el = document.getElementById(elementId);
    if (el) {
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }
}

function showTooltip(id, event) {
    // Legacy function - now handled by showKernelDensity
}

function hideTooltip(id) {
    // Legacy function - now handled by hideKernelDensity
}

// ==================== KERNEL DENSITY ESTIMATION ====================
function drawKernelDensity(canvasId, components) {
    const canvas = document.getElementById(canvasId);
    if (!canvas || !components || components.length === 0) return;
    
    const samples = [];
    components.forEach(c => {
        const count = Math.round(c.weight * 30);
        for (let i = 0; i < count; i++) {
            samples.push(c.point_score + (Math.random() - 0.5) * 5);
        }
    });

    if (samples.length < 2) return;
    
    const ctx = canvas.getContext('2d');
    const bandwidth = Math.max(1, Math.sqrt(variance(samples)) * Math.pow(samples.length, -0.2));
    
    const kdeData = [];
    for (let x = 0; x <= 100; x += 3) {
        kdeData.push({x: x, y: kernelDensityEstimator(kernelEpanechnikov(bandwidth), samples)(x)});
    }
    
    new Chart(ctx, {
        type: 'line',
        data: { 
            datasets: [{ 
                data: kdeData, 
                borderColor: 'rgba(118, 75, 162, 0.8)', 
                fill: true, 
                backgroundColor: 'rgba(118, 75, 162, 0.2)', 
                borderWidth: 2, 
                pointRadius: 0,
                tension: 0.4
            }] 
        },
        options: {
            responsive: true, 
            maintainAspectRatio: false,
            scales: { 
                x: { display: false }, 
                y: { display: false } 
            },
            plugins: { 
                legend: { display: false }, 
                tooltip: { enabled: false } 
            }
        }
    });
}

// Fixed version for strategy map to prevent layout issues
function drawKernelDensityFixed(canvasId, components) {
    const canvas = document.getElementById(canvasId);
    if (!canvas || !components || components.length === 0) return;
    
    // Set fixed canvas dimensions to prevent layout issues
    canvas.width = 200;
    canvas.height = 80;
    canvas.style.width = '100%';
    canvas.style.height = '80px';
    
    const samples = [];
    components.forEach(c => {
        const count = Math.round(c.weight * 20); // Reduced count for performance
        for (let i = 0; i < count; i++) {
            samples.push(c.point_score + (Math.random() - 0.5) * 3);
        }
    });

    if (samples.length < 2) return;
    
    try {
        const ctx = canvas.getContext('2d');
        
        // Clear any existing chart
        const existingChart = Chart.getChart(canvas);
        if (existingChart) {
            existingChart.destroy();
        }
        
        const bandwidth = Math.max(1, Math.sqrt(variance(samples)) * Math.pow(samples.length, -0.2));
        
        const kdeData = [];
        for (let x = 0; x <= 100; x += 5) { // Larger steps for performance
            kdeData.push({x: x, y: kernelDensityEstimator(kernelEpanechnikov(bandwidth), samples)(x)});
        }
        
        new Chart(ctx, {
            type: 'line',
            data: { 
                datasets: [{ 
                    data: kdeData, 
                    borderColor: 'rgba(118, 75, 162, 0.8)', 
                    fill: true, 
                    backgroundColor: 'rgba(118, 75, 162, 0.2)', 
                    borderWidth: 2, 
                    pointRadius: 0,
                    tension: 0.4
                }] 
            },
            options: {
                responsive: false, // Disable responsive to prevent layout issues
                maintainAspectRatio: false,
                animation: false, // Disable animation for performance
                scales: { 
                    x: { display: false }, 
                    y: { display: false } 
                },
                plugins: { 
                    legend: { display: false }, 
                    tooltip: { enabled: false } 
                },
                layout: {
                    padding: 0
                }
            }
        });
    } catch (e) {
        console.warn('Chart creation failed:', e);
    }
}

function kernelDensityEstimator(kernel, X) {
    return function(V) {
        return X.map(x => kernel(V - x)).reduce((s, a) => s + a, 0) / X.length;
    };
}

function kernelEpanechnikov(k) {
    return function(v) {
        return Math.abs(v /= k) <= 1 ? 0.75 * (1 - v * v) / k : 0;
    };
}

function variance(arr) {
    const mean = arr.reduce((a,b)=>a+b,0) / arr.length;
    return arr.reduce((acc, val) => acc + (val - mean) ** 2, 0) / arr.length;
}

// ==================== PDF DOWNLOAD ====================
async function downloadPDF() {
    loadingOverlay.style.display = 'flex';
    loadingOverlay.querySelector('p').textContent = 'PDF ÏÉùÏÑ± Ï§ë...';
    
    try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        // Add cover page with current selections and annotations
        addCoverPage(pdf);
        
        const pagesToCapture = ['map-page', 'comparison-page', 'franchise-page', 'typemap-page', 'strategymap-page'];
        const pageDescriptions = {
            'map-page': 'ÏßÄÎèÑ Î∂ÑÏÑù: ÏùåÏãùÏ†ê ÏúÑÏπòÏôÄ ÌûàÌä∏ÎßµÏùÑ ÌÜµÌïú ÏÉÅÍ∂å Î∂ÑÏÑù. Ï†êÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.',
            'comparison-page': 'ÏßÄÏó≠ ÌäπÏÑ± ÎπÑÍµê: Îëê ÏßÄÏó≠Ïùò Ï£ºÏöî ÏßÄÌëúÎ•º ÎπÑÍµê Î∂ÑÏÑùÌï©ÎãàÎã§. Î≥ÄÏàòÎ•º Ï∂îÍ∞Ä/Ï†úÍ±∞ÌïòÏó¨ ÎßûÏ∂§ Î∂ÑÏÑùÏù¥ Í∞ÄÎä•Ìï©ÎãàÎã§.',
            'franchise-page': 'ÏùåÏãùÏ†ê Ïú†Ìòï Î∂ÑÏÑù: ÏÑ†ÌÉùÎêú ÏùåÏãùÏ†ê Ïú†ÌòïÏùò Ï∞®Î≥ÑÌôîÎêú Îß§Ïû•Îì§ÏùÑ Î∂ÑÏÑùÌï©ÎãàÎã§.',
            'typemap-page': 'ÏùåÏãùÏ†ê Ïú†Ìòï ÏßÄÎèÑ: Í∞Å ÏùåÏãùÏ†ê Ïú†ÌòïÏùò ÌäπÏÑ±ÏùÑ 2Ï∞®Ïõê ÏßÄÎèÑÎ°ú ÏãúÍ∞ÅÌôîÌï©ÎãàÎã§.',
            'strategymap-page': 'Í∞ÄÍ≤åÎ≥Ñ Ï†ÑÎûµ ÏßÄÎèÑ: ÏÑ†ÌÉùÎêú ÏùåÏãùÏ†ê Ïú†ÌòïÏùò Í∞ÄÍ≤åÎì§ÏùÑ Î≥ÄÏàòÎ≥ÑÎ°ú ÏãúÍ∞ÅÌôîÌïòÏó¨ Ìè¨ÏßÄÏÖîÎãùÏùÑ Î∂ÑÏÑùÌï©ÎãàÎã§.'
        };
        
        for(let i = 0; i < pagesToCapture.length; i++) {
            loadingOverlay.querySelector('p').textContent = `PDF ÏÉùÏÑ± Ï§ë... (${i+2}/${pagesToCapture.length+1})`;
            
            pdf.addPage();
            
            // Add page title and description
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text(pageDescriptions[pagesToCapture[i]].split(':')[0], 20, 25);
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            const description = pageDescriptions[pagesToCapture[i]].split(':')[1];
            const lines = pdf.splitTextToSize(description, 170);
            pdf.text(lines, 20, 35);
            
            navigateTo(pagesToCapture[i]);
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const canvas = await html2canvas(document.getElementById(pagesToCapture[i]), { 
                scale: 1.2,
                logging: false,
                useCORS: true,
                height: window.innerHeight - 100
            });
            const imgData = canvas.toDataURL('image/png');
            
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth() - 40;
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            pdf.addImage(imgData, 'PNG', 20, 50, pdfWidth, Math.min(pdfHeight, 230));
        }
        
        const currentDate = new Date().toLocaleDateString('ko-KR');
        pdf.save(`ÏÉÅÍ∂åÎ∂ÑÏÑù_Î¶¨Ìè¨Ìä∏_${currentDate}.pdf`);
        
    } catch(e) {
        console.error("PDF generation failed:", e);
        alert("PDF ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
    } finally {
        loadingOverlay.style.display = 'none';
        loadingOverlay.querySelector('p').textContent = 'Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...';
        navigateTo('map-page');
    }
}

function addCoverPage(pdf) {
    // Cover page with current selections
    pdf.setFontSize(24);
    pdf.setFont(undefined, 'bold');
    pdf.text('ÏÉÅÍ∂å.shop Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏', 20, 30);
    
    pdf.setFontSize(14);
    pdf.setFont(undefined, 'normal');
    pdf.text(`ÏÉùÏÑ±ÏùºÏãú: ${new Date().toLocaleDateString('ko-KR')} ${new Date().toLocaleTimeString('ko-KR')}`, 20, 45);
    
    // Current selections summary
    pdf.setFontSize(16);
    pdf.setFont(undefined, 'bold');
    pdf.text('ÌòÑÏû¨ ÏÑ†ÌÉù ÏÇ¨Ìï≠', 20, 65);
    
    pdf.setFontSize(12);
    pdf.setFont(undefined, 'normal');
    let yPos = 80;
    
    // Get current selections from various pages
    const heatmapVar = document.getElementById('heatmapVariable')?.value || 'ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏùå';
    const categoryFilter = document.getElementById('mapCategoryFilter')?.value || 'Ï†ÑÏ≤¥';
    const deviationMode = document.getElementById('deviationToggle')?.checked ? 'ÌôúÏÑ±Ìôî' : 'ÎπÑÌôúÏÑ±Ìôî';
    
    pdf.text(`‚Ä¢ ÌûàÌä∏Îßµ Î≥ÄÏàò: ${variableLabels[heatmapVar] || heatmapVar}`, 25, yPos);
    yPos += 10;
    pdf.text(`‚Ä¢ ÏóÖÏ¢Ö ÌïÑÌÑ∞: ${categoryFilter}`, 25, yPos);
    yPos += 10;
    pdf.text(`‚Ä¢ ÌãàÏÉà ÏãúÏû• ÌëúÏãú: ${deviationMode}`, 25, yPos);
    yPos += 15;
    
    // Summary statistics
    pdf.setFontSize(16);
    pdf.setFont(undefined, 'bold');
    pdf.text('Îç∞Ïù¥ÌÑ∞ ÏöîÏïΩ', 20, yPos);
    yPos += 15;
    
    pdf.setFontSize(12);
    pdf.setFont(undefined, 'normal');
    pdf.text(`‚Ä¢ Ï†ÑÏ≤¥ ÏùåÏãùÏ†ê Ïàò: ${allRestaurants.length}Í∞ú`, 25, yPos);
    yPos += 10;
    
    const subcategories = [...new Set(allRestaurants.map(r => r.subcategory))];
    pdf.text(`‚Ä¢ ÏùåÏãùÏ†ê Ïú†Ìòï: ${subcategories.join(', ')}`, 25, yPos);
    yPos += 10;
    
    const emds = [...new Set(allRestaurants.map(r => r.emd))];
    pdf.text(`‚Ä¢ Î∂ÑÏÑù ÏßÄÏó≠: ${emds.join(', ')}`, 25, yPos);
    yPos += 20;
    
    // Instructions
    pdf.setFontSize(16);
    pdf.setFont(undefined, 'bold');
    pdf.text('ÏÇ¨Ïö© Î∞©Î≤ï', 20, yPos);
    yPos += 15;
    
    pdf.setFontSize(10);
    pdf.setFont(undefined, 'normal');
    const instructions = [
        '‚Ä¢ ÏßÄÎèÑ Î∂ÑÏÑù: Ï†êÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ Í∞ÄÍ≤å ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌôïÏù∏ Í∞ÄÎä•',
        '‚Ä¢ ÏßÄÏó≠ ÎπÑÍµê: Î≥ÄÏàò Ï∂îÍ∞Ä/Ï†úÍ±∞Î°ú ÎßûÏ∂§ Î∂ÑÏÑù',
        '‚Ä¢ ÏùåÏãùÏ†ê Ïú†Ìòï Î∂ÑÏÑù: Ïú†ÌòïÎ≥Ñ Ï∞®Î≥ÑÌôî ÏöîÏÜå Î∂ÑÏÑù',
        '‚Ä¢ Ï†ÑÎûµ ÏßÄÎèÑ: Ï†ê ÌÅ¥Î¶≠ÏúºÎ°ú Í∞ÄÍ≤å ÎπÑÍµê Î∂ÑÏÑù',
        '‚Ä¢ Î™®Îì† Ï∞®Ìä∏Îäî Îç∞Ïù¥ÌÑ∞ Î≤îÏúÑÏóê ÎßûÏ∂∞ ÏûêÎèô Ï°∞Ï†ïÎê®'
    ];
    
    instructions.forEach(instruction => {
        pdf.text(instruction, 25, yPos);
        yPos += 8;
    });
}



// ==================== APPLICATION STARTUP ====================
document.addEventListener('DOMContentLoaded', loadAllData);

</script>
</body>
</html>